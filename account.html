<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VocabLoop Account</title>
  <style>
    :root{
      --bg-a:#dbeafe; --bg-b:#dcfce7; --bg-c:#ede9fe;
      --card:rgba(255,255,255,.88); --ink:#0f172a; --muted:#64748b;
      --line:#dbe2ea; --pri:#2563eb; --pri2:#1d4ed8;
      --ok:#16a34a; --err:#dc2626; --warn:#d97706;
      --shadow:0 14px 36px rgba(2,6,23,.12);
    }
    [data-theme="dark"]{
      --bg-a:#0b1220; --bg-b:#111827; --bg-c:#1e1b4b;
      --card:rgba(15,23,42,.72); --ink:#e5e7eb; --muted:#9ca3af;
      --line:#334155; --pri:#3b82f6; --pri2:#2563eb;
      --ok:#22c55e; --err:#f87171; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at -10% -20%, var(--bg-c) 0%, transparent 60%),
        linear-gradient(145deg,var(--bg-a),var(--bg-b));
      min-height:100vh;
      transition: background .25s ease, color .25s ease;
    }

    .wrap{max-width:600px;margin:24px auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
    .back,.ghost{
      border:1px solid var(--line);background:var(--card);border-radius:10px;padding:8px 12px;
      color:var(--ink);text-decoration:none;font-weight:700;cursor:pointer;
      transition: transform .12s, box-shadow .12s
    }
    .back:hover,.ghost:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .back:active,.ghost:active{transform:translateY(0);box-shadow:none}

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid color-mix(in srgb, var(--line) 60%, transparent);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    h1{margin:4px 0 6px;font-size:1.48rem;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:.92rem;line-height:1.45}

    /* ‚îÄ‚îÄ Tabs with sliding indicator ‚îÄ‚îÄ */
    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:0;margin:16px 0 12px;position:relative;
      background:color-mix(in srgb, var(--line) 35%, transparent);border-radius:14px;padding:3px}
    .tab{border:0;background:transparent;color:var(--muted);border-radius:11px;padding:11px;
      font-weight:800;cursor:pointer;transition: color .2s;position:relative;z-index:1}
    .tab.active{color:#fff}
    .tab-slider{position:absolute;top:3px;left:3px;width:calc(50% - 3px);height:calc(100% - 6px);
      background:linear-gradient(180deg,var(--pri),var(--pri2));border-radius:11px;
      transition:transform .28s cubic-bezier(.4,0,.2,1);
      box-shadow:0 4px 14px color-mix(in srgb, var(--pri) 35%, transparent);z-index:0}
    .tab-slider.right{transform:translateX(100%)}

    /* ‚îÄ‚îÄ Panel transitions ‚îÄ‚îÄ */
    .panels{position:relative;overflow:hidden}
    .panel{display:none;animation:panelIn .25s ease}
    .panel.active{display:block}
    @keyframes panelIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    label{display:flex;justify-content:space-between;align-items:center;margin:11px 0 6px;font-size:.92rem;font-weight:700}
    .tiny{font-size:.75rem;color:var(--muted);font-weight:600}

    .input-wrap{position:relative}
    input{
      width:100%;padding:12px 42px 12px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:1rem;outline:none;background:transparent;color:var(--ink);transition:.15s
    }
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px color-mix(in srgb, #93c5fd 32%, transparent)}
    input.invalid{border-color:color-mix(in srgb, var(--err) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--err) 20%, transparent)}
    input.valid{border-color:color-mix(in srgb, var(--ok) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--ok) 20%, transparent)}

    .toggle-eye{
      position:absolute;right:9px;top:50%;transform:translateY(-50%);
      border:0;background:transparent;color:var(--muted);cursor:pointer;font-size:1rem;
      transition:color .15s
    }
    .toggle-eye:hover{color:var(--ink)}

    /* ‚îÄ‚îÄ Password strength meter ‚îÄ‚îÄ */
    .strength-bar{height:4px;border-radius:2px;background:var(--line);margin-top:6px;overflow:hidden}
    .strength-fill{height:100%;width:0;border-radius:2px;transition:width .3s ease,background .3s ease}
    .strength-fill.s1{width:33%;background:var(--err)}
    .strength-fill.s2{width:66%;background:var(--warn)}
    .strength-fill.s3{width:100%;background:var(--ok)}

    .inline{font-size:.82rem;margin-top:6px;min-height:1.2em;line-height:1.35;
      transition:opacity .2s}
    .inline.ok{color:var(--ok)} .inline.err{color:var(--err)} .inline.warn{color:var(--warn)}

    /* ‚îÄ‚îÄ CTA buttons ‚îÄ‚îÄ */
    .cta{
      margin-top:16px;width:100%;border:0;border-radius:12px;padding:13px;
      color:#fff;background:linear-gradient(180deg,var(--pri),var(--pri2));font-weight:800;cursor:pointer;
      font-size:.95rem;letter-spacing:.3px;
      transition: transform .12s, box-shadow .15s, opacity .15s;
      box-shadow:0 8px 18px color-mix(in srgb, var(--pri) 36%, transparent);
      display:flex;align-items:center;justify-content:center;gap:8px
    }
    .cta:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 10px 24px color-mix(in srgb, var(--pri) 45%, transparent)}
    .cta:active:not(:disabled){transform:translateY(1px);box-shadow:0 4px 10px color-mix(in srgb, var(--pri) 25%, transparent)}
    .cta:disabled{opacity:.65;cursor:not-allowed}

    /* ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ */
    .spinner{display:none;width:18px;height:18px;border:2.5px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    .cta.loading .spinner{display:block}
    .cta.loading .btn-text{opacity:.8}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ‚îÄ‚îÄ Message box ‚îÄ‚îÄ */
    .msg{margin-top:12px;padding:10px 12px;border-radius:11px;font-size:.92rem;
      display:none;align-items:center;gap:8px;animation:msgIn .25s ease}
    .msg.ok{display:flex;background:color-mix(in srgb, var(--ok) 13%, transparent);color:var(--ok);
      border:1px solid color-mix(in srgb, var(--ok) 40%, transparent)}
    .msg.err{display:flex;background:color-mix(in srgb, var(--err) 12%, transparent);color:var(--err);
      border:1px solid color-mix(in srgb, var(--err) 40%, transparent)}
    .msg-icon{font-size:1.1rem;flex-shrink:0}
    @keyframes msgIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

    /* ‚îÄ‚îÄ Shake on error ‚îÄ‚îÄ */
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .shake{animation:shake .4s ease}

    /* ‚îÄ‚îÄ Success overlay ‚îÄ‚îÄ */
    .success-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.35);backdrop-filter:blur(4px);z-index:100;opacity:0;
      transition:opacity .3s ease;pointer-events:none}
    .success-overlay.show{opacity:1;pointer-events:auto}
    .success-check{width:80px;height:80px;border-radius:50%;
      background:linear-gradient(135deg,var(--ok),#16a34a);
      display:flex;align-items:center;justify-content:center;
      transform:scale(0);transition:transform .35s cubic-bezier(.34,1.56,.64,1)}
    .success-overlay.show .success-check{transform:scale(1)}
    .success-check svg{width:44px;height:44px}
    .check-path{stroke-dasharray:50;stroke-dashoffset:50;animation:drawCheck .4s .3s ease forwards}
    @keyframes drawCheck{to{stroke-dashoffset:0}}

    /* ‚îÄ‚îÄ Logged-in profile panel ‚îÄ‚îÄ */
    .profile{text-align:center;padding:16px 0}
    .profile-avatar{width:72px;height:72px;border-radius:50%;
      background:linear-gradient(135deg,var(--pri),#8b5cf6);
      display:inline-flex;align-items:center;justify-content:center;
      font-size:2rem;color:#fff;font-weight:700;margin-bottom:12px}
    .profile-name{font-size:1.3rem;font-weight:800;margin-bottom:4px}
    .profile-meta{color:var(--muted);font-size:.88rem;margin-bottom:16px}
    .btn-logout{border:1px solid var(--err);background:transparent;color:var(--err);border-radius:12px;
      padding:10px 24px;font-weight:700;cursor:pointer;transition:.15s;font-size:.92rem}
    .btn-logout:hover{background:color-mix(in srgb, var(--err) 10%, transparent)}

    @media (max-width: 520px){
      .wrap{margin:12px auto}
      .card{padding:14px}
      h1{font-size:1.3rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="/" id="backBtn">‚Üê Back to Home</a>
      <button class="ghost" id="themeBtn">üåì Theme</button>
    </div>

    <div class="card">
      <!-- Logged-in profile view -->
      <div id="profilePanel" class="profile" style="display:none">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-name" id="profileName">username</div>
        <div class="profile-meta" id="profileMeta">Logged in</div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>

      <!-- Auth form view -->
      <div id="authPanel">
        <h1 id="title">Account</h1>
        <div class="muted" id="subtitle">Create your account or login to continue learning across sessions.</div>

        <div class="tabs">
          <button id="tabRegister" class="tab active">Register</button>
          <button id="tabLogin" class="tab">Login</button>
          <div class="tab-slider" id="tabSlider"></div>
        </div>

        <div class="panels">
          <div id="panelRegister" class="panel active">
            <form id="registerForm" autocomplete="on" novalidate>
              <label for="rUser"><span id="labelUser">Username</span> <span class="tiny" id="ruleUser">min 5 chars</span></label>
              <div class="input-wrap"><input id="rUser" placeholder="At least 5 characters" autocomplete="username" /></div>
              <div id="rUserHint" class="inline"></div>

              <label for="rPass"><span id="labelPass">Password</span> <span class="tiny" id="rulePass">digits only, min 6</span></label>
              <div class="input-wrap">
                <input id="rPass" type="password" inputmode="numeric" placeholder="At least 6 digits" autocomplete="new-password" />
                <button type="button" class="toggle-eye" data-target="rPass">üëÅÔ∏è</button>
              </div>
              <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
              <div id="rPassHint" class="inline"></div>

              <label for="rPass2" id="labelPass2">Confirm Password</label>
              <div class="input-wrap">
                <input id="rPass2" type="password" inputmode="numeric" placeholder="Re-enter your password" autocomplete="new-password" />
                <button type="button" class="toggle-eye" data-target="rPass2">üëÅÔ∏è</button>
              </div>
              <div id="rPass2Hint" class="inline"></div>

              <button type="submit" id="registerBtn" class="cta">
                <span class="btn-text">Create Account</span>
                <span class="spinner"></span>
              </button>
            </form>
          </div>

          <div id="panelLogin" class="panel">
            <form id="loginForm" autocomplete="on" novalidate>
              <label for="lUser" id="lUserLabel">Username</label>
              <div class="input-wrap"><input id="lUser" placeholder="Your username" autocomplete="username" /></div>

              <label for="lPass" id="lPassLabel">Password</label>
              <div class="input-wrap">
                <input id="lPass" type="password" inputmode="numeric" placeholder="Your password" autocomplete="current-password" />
                <button type="button" class="toggle-eye" data-target="lPass">üëÅÔ∏è</button>
              </div>

              <button type="submit" id="loginBtn" class="cta">
                <span class="btn-text">Login</span>
                <span class="spinner"></span>
              </button>
            </form>
          </div>
        </div>

        <div id="msg" class="msg"><span class="msg-icon"></span><span class="msg-text"></span></div>
      </div>
    </div>
  </div>

  <!-- Success overlay -->
  <div class="success-overlay" id="successOverlay">
    <div class="success-check">
      <svg viewBox="0 0 44 44" fill="none">
        <path class="check-path" d="M10 22 L19 31 L34 14" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <script>
    const I18N = {
      en: {
        back:'‚Üê Back to Home', theme:'üåì Theme', title:'Account',
        subtitle:'Create your account or login to continue learning across sessions.',
        register:'Register', login:'Login',
        username:'Username', userRule:'min 5 chars',
        password:'Password', passRule:'digits only, min 6',
        confirm:'Confirm Password',
        phUser:'At least 5 characters', phPass:'At least 6 digits', phPass2:'Re-enter your password',
        loginUser:'Your username', loginPass:'Your password',
        create:'Create Account', creating:'Creating...',
        loginBtn:'Login', logging:'Logging in...',
        hUserOk:'Looks good.', hUserBad:'Username must be at least 5 characters.',
        hPassOk:'Password format is valid.', hPassBad:'Use digits only, at least 6 numbers.',
        hPass2Ok:'Passwords match.', hPass2Bad:'Passwords do not match yet.',
        fixFields:'Please fix the highlighted fields, then try again.',
        registerOk:'Account created. You are now logged in!',
        registerTaken:'This username is already taken. Try another one, or login directly.',
        registerFail:'Register failed. Please try again.',
        loginOk:(u)=>`Welcome back, ${u}!`,
        loginFail:'Login failed. Please check username/password and try again.',
        network:'Network issue. Please retry in a moment.',
        loggedIn:'Logged in',
        logout:'Logout',
        logoutConfirm:'Are you sure you want to logout?',
        strengthWeak:'Weak', strengthMedium:'Medium', strengthStrong:'Strong'
      },
      zh: {
        back:'‚Üê ËøîÂõûÈ¶ñÈ°µ', theme:'üåì ‰∏ªÈ¢ò', title:'Ë¥¶Êà∑',
        subtitle:'ÂàõÂª∫Êñ∞Ë¥¶Âè∑ÊàñÁôªÂΩïÔºåÁªßÁª≠‰Ω†ÁöÑÂ≠¶‰π†ËøõÂ∫¶„ÄÇ',
        register:'Ê≥®ÂÜå', login:'ÁôªÂΩï',
        username:'Áî®Êà∑Âêç', userRule:'Ëá≥Â∞ë5‰∏™Â≠óÁ¨¶',
        password:'ÂØÜÁ†Å', passRule:'‰ªÖÊï∞Â≠óÔºåËá≥Â∞ë6‰Ωç',
        confirm:'Á°ÆËÆ§ÂØÜÁ†Å',
        phUser:'Ëá≥Â∞ë5‰∏™Â≠óÁ¨¶', phPass:'Ëá≥Â∞ë6‰ΩçÊï∞Â≠ó', phPass2:'ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å',
        loginUser:'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç', loginPass:'ËØ∑ËæìÂÖ•ÂØÜÁ†Å',
        create:'ÂàõÂª∫Ë¥¶Âè∑', creating:'ÂàõÂª∫‰∏≠...',
        loginBtn:'ÁôªÂΩï', logging:'ÁôªÂΩï‰∏≠...',
        hUserOk:'Áî®Êà∑ÂêçÂèØÁî®„ÄÇ', hUserBad:'Áî®Êà∑ÂêçËá≥Â∞ëÈúÄË¶Å5‰∏™Â≠óÁ¨¶„ÄÇ',
        hPassOk:'ÂØÜÁ†ÅÊ†ºÂºèÊ≠£Á°Æ„ÄÇ', hPassBad:'ÂØÜÁ†ÅÈúÄ‰∏∫Ëá≥Â∞ë6‰ΩçÊï∞Â≠ó„ÄÇ',
        hPass2Ok:'‰∏§Ê¨°ÂØÜÁ†Å‰∏ÄËá¥„ÄÇ', hPass2Bad:'‰∏§Ê¨°ÂØÜÁ†ÅÊöÇÊú™‰∏ÄËá¥„ÄÇ',
        fixFields:'ËØ∑ÂÖà‰øÆÊ≠£È´ò‰∫ÆÂ≠óÊÆµÂêéÂÜçÊèê‰∫§„ÄÇ',
        registerOk:'Ê≥®ÂÜåÊàêÂäüÔºåÂ∑≤Ëá™Âä®ÁôªÂΩïÔºÅ',
        registerTaken:'ËØ•Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºåÂª∫ËÆÆÊõ¥Êç¢ÊàñÁõ¥Êé•ÁôªÂΩï„ÄÇ',
        registerFail:'Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ',
        loginOk:(u)=>`Ê¨¢ËøéÂõûÊù•Ôºå${u}ÔºÅ`,
        loginFail:'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÊàñÂØÜÁ†Å„ÄÇ',
        network:'ÁΩëÁªúÂºÇÂ∏∏ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ',
        loggedIn:'Â∑≤ÁôªÂΩï',
        logout:'ÈÄÄÂá∫ÁôªÂΩï',
        logoutConfirm:'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü',
        strengthWeak:'Âº±', strengthMedium:'‰∏≠', strengthStrong:'Âº∫'
      }
    };

    const state = {
      lang: (navigator.language || '').toLowerCase().startsWith('zh') ? 'zh' : 'en',
      t: null,
      theme: localStorage.getItem('vocabloop_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
      currentTab: 'register',
      touched: { rUser: false, rPass: false, rPass2: false }
    };

    /* ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ */
    const $ = id => document.getElementById(id);
    const msgEl = $('msg');
    const rUser = $('rUser');
    const rPass = $('rPass');
    const rPass2 = $('rPass2');

    /* ‚îÄ‚îÄ Theme ‚îÄ‚îÄ */
    function applyTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('vocabloop_theme', theme);
    }
    function switchTheme(){ applyTheme(state.theme === 'dark' ? 'light' : 'dark'); }

    /* ‚îÄ‚îÄ i18n ‚îÄ‚îÄ */
    function applyI18n(){
      state.t = I18N[state.lang] || I18N.en;
      const t = state.t;
      document.documentElement.lang = state.lang === 'zh' ? 'zh-CN' : 'en';
      $('backBtn').textContent = t.back;
      $('themeBtn').textContent = t.theme;
      $('title').textContent = t.title;
      $('subtitle').textContent = t.subtitle;
      $('tabRegister').textContent = t.register;
      $('tabLogin').textContent = t.login;
      $('labelUser').textContent = t.username;
      $('ruleUser').textContent = t.userRule;
      $('labelPass').textContent = t.password;
      $('rulePass').textContent = t.passRule;
      $('labelPass2').textContent = t.confirm;
      $('lUserLabel').textContent = t.username;
      $('lPassLabel').textContent = t.password;
      $('registerBtn').querySelector('.btn-text').textContent = t.create;
      $('loginBtn').querySelector('.btn-text').textContent = t.loginBtn;
      rUser.placeholder = t.phUser; rPass.placeholder = t.phPass; rPass2.placeholder = t.phPass2;
      $('lUser').placeholder = t.loginUser;
      $('lPass').placeholder = t.loginPass;
      $('logoutBtn').textContent = t.logout;
    }

    /* ‚îÄ‚îÄ Tab switching with sliding indicator ‚îÄ‚îÄ */
    function switchTab(tab){
      state.currentTab = tab;
      const isRegister = tab === 'register';
      $('tabRegister').classList.toggle('active', isRegister);
      $('tabLogin').classList.toggle('active', !isRegister);
      $('tabSlider').classList.toggle('right', !isRegister);
      $('panelRegister').classList.toggle('active', isRegister);
      $('panelLogin').classList.toggle('active', !isRegister);
      setMsg('', '');
      /* Auto-focus first input */
      setTimeout(() => {
        const target = isRegister ? rUser : $('lUser');
        target.focus();
      }, 280);
    }

    /* ‚îÄ‚îÄ Password toggle ‚îÄ‚îÄ */
    document.querySelectorAll('.toggle-eye').forEach(btn => {
      btn.addEventListener('click', function(){
        const input = $(this.dataset.target);
        input.type = input.type === 'password' ? 'text' : 'password';
        this.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
      });
    });

    /* ‚îÄ‚îÄ Message display ‚îÄ‚îÄ */
    function setMsg(text, type){
      msgEl.className = 'msg';
      const iconEl = msgEl.querySelector('.msg-icon');
      const textEl = msgEl.querySelector('.msg-text');
      textEl.textContent = text || '';
      if(!text){ iconEl.textContent = ''; return; }
      iconEl.textContent = type === 'ok' ? '‚úì' : '‚úï';
      msgEl.classList.add(type === 'ok' ? 'ok' : 'err');
    }

    /* ‚îÄ‚îÄ Auth persistence ‚îÄ‚îÄ */
    function saveAuth(user, token){
      if(!user || !user.username || !token) return;
      localStorage.setItem('vocabloop_auth', JSON.stringify({ username:user.username, token, at:Date.now() }));
    }
    function getAuth(){
      try{ return JSON.parse(localStorage.getItem('vocabloop_auth')); }catch(e){ return null; }
    }
    function clearAuth(){ localStorage.removeItem('vocabloop_auth'); }

    /* ‚îÄ‚îÄ Success overlay + redirect ‚îÄ‚îÄ */
    function showSuccessAndRedirect(){
      const overlay = $('successOverlay');
      overlay.classList.add('show');
      setTimeout(() => { window.location.href = '/'; }, 1200);
    }

    /* ‚îÄ‚îÄ Shake animation helper ‚îÄ‚îÄ */
    function shakeEl(el){
      el.classList.remove('shake');
      void el.offsetWidth;
      el.classList.add('shake');
    }

    /* ‚îÄ‚îÄ Inline hints ‚îÄ‚îÄ */
    function setInline(elId, text, type){
      const el = $(elId);
      el.className = 'inline';
      el.textContent = text || '';
      if(type) el.classList.add(type);
    }

    /* ‚îÄ‚îÄ Password strength meter ‚îÄ‚îÄ */
    function updateStrength(val){
      const fill = $('strengthFill');
      fill.className = 'strength-fill';
      if(!val){ return; }
      const digits = val.replace(/\D/g, '');
      if(digits.length >= 10) fill.classList.add('s3');
      else if(digits.length >= 6) fill.classList.add('s2');
      else if(digits.length >= 1) fill.classList.add('s1');
    }

    /* ‚îÄ‚îÄ Register validation (only validates touched fields) ‚îÄ‚îÄ */
    function validateRegisterForm(submitAttempt){
      const t = state.t;
      const u = rUser.value.trim();
      const p = rPass.value.trim();
      const p2 = rPass2.value.trim();
      let ok = true;

      /* Username */
      if(state.touched.rUser || submitAttempt){
        if(u.length >= 5){
          setInline('rUserHint',t.hUserOk,'ok'); rUser.classList.add('valid'); rUser.classList.remove('invalid');
        } else {
          ok = false; setInline('rUserHint',t.hUserBad,'warn'); rUser.classList.add('invalid'); rUser.classList.remove('valid');
        }
      } else if(u.length < 5) ok = false;

      /* Password */
      if(state.touched.rPass || submitAttempt){
        if(/^\d{6,}$/.test(p)){
          setInline('rPassHint',t.hPassOk,'ok'); rPass.classList.add('valid'); rPass.classList.remove('invalid');
        } else {
          ok = false; setInline('rPassHint',t.hPassBad,'warn'); rPass.classList.add('invalid'); rPass.classList.remove('valid');
        }
      } else if(!/^\d{6,}$/.test(p)) ok = false;

      /* Confirm password */
      if(state.touched.rPass2 || submitAttempt){
        if(p2 && p === p2){
          setInline('rPass2Hint',t.hPass2Ok,'ok'); rPass2.classList.add('valid'); rPass2.classList.remove('invalid');
        } else {
          ok = false; setInline('rPass2Hint',t.hPass2Bad,'err'); rPass2.classList.add('invalid'); rPass2.classList.remove('valid');
        }
      } else if(!p2 || p !== p2) ok = false;

      updateStrength(p);
      return ok;
    }

    /* ‚îÄ‚îÄ Set button loading state ‚îÄ‚îÄ */
    function setBtnLoading(btn, loading, text){
      btn.disabled = loading;
      btn.classList.toggle('loading', loading);
      btn.querySelector('.btn-text').textContent = text;
    }

    /* ‚îÄ‚îÄ API call ‚îÄ‚îÄ */
    async function callAuth(payload){
      const r = await fetch('/api/auth', {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)
      });
      return r.json();
    }

    /* ‚îÄ‚îÄ Register ‚îÄ‚îÄ */
    async function register(){
      const t = state.t;
      /* Mark all fields as touched on submit attempt */
      state.touched.rUser = state.touched.rPass = state.touched.rPass2 = true;
      if(!validateRegisterForm(true)){
        setMsg(t.fixFields, 'err');
        shakeEl($('registerBtn'));
        return;
      }
      const btn = $('registerBtn');
      setBtnLoading(btn, true, t.creating);
      try{
        const data = await callAuth({ action:'register', username:rUser.value.trim(), password:rPass.value.trim() });
        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(t.registerOk, 'ok');
          showSuccessAndRedirect();
        } else {
          const m = (data.message || '').toLowerCase();
          if(m.includes('exists')) setMsg(t.registerTaken, 'err');
          else setMsg(data.message || t.registerFail, 'err');
          shakeEl(btn);
        }
      }catch(_){ setMsg(t.network, 'err'); shakeEl(btn); }
      finally { setBtnLoading(btn, false, t.create); }
    }

    /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
    async function login(){
      const t = state.t;
      const btn = $('loginBtn');
      const uVal = $('lUser').value.trim();
      const pVal = $('lPass').value.trim();
      if(!uVal || !pVal){
        setMsg(t.fixFields, 'err'); shakeEl(btn); return;
      }
      setBtnLoading(btn, true, t.logging);
      try{
        const data = await callAuth({ action:'login', username:uVal, password:pVal });
        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(t.loginOk(data.user?.username || 'user'), 'ok');
          showSuccessAndRedirect();
        } else { setMsg(t.loginFail, 'err'); shakeEl(btn); }
      }catch(_){ setMsg(t.network, 'err'); shakeEl(btn); }
      finally { setBtnLoading(btn, false, t.loginBtn); }
    }

    /* ‚îÄ‚îÄ Logged-in profile view ‚îÄ‚îÄ */
    function showProfile(auth){
      $('authPanel').style.display = 'none';
      $('profilePanel').style.display = 'block';
      const name = auth.username || 'User';
      $('profileAvatar').textContent = name.charAt(0).toUpperCase();
      $('profileName').textContent = name;
      $('profileMeta').textContent = state.t.loggedIn;
    }

    function handleLogout(){
      if(!confirm(state.t.logoutConfirm)) return;
      clearAuth();
      $('authPanel').style.display = 'block';
      $('profilePanel').style.display = 'none';
      switchTab('login');
    }

    /* ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ */
    /* Track which fields user has touched for gentle validation */
    rUser.addEventListener('focus', () => { state.touched.rUser = true; });
    rPass.addEventListener('focus', () => { state.touched.rPass = true; });
    rPass2.addEventListener('focus', () => { state.touched.rPass2 = true; });
    [rUser, rPass, rPass2].forEach(el => el.addEventListener('input', () => validateRegisterForm(false)));

    /* Form submit via Enter key */
    $('registerForm').addEventListener('submit', e => { e.preventDefault(); register(); });
    $('loginForm').addEventListener('submit', e => { e.preventDefault(); login(); });

    /* Tab buttons */
    $('tabRegister').addEventListener('click', () => switchTab('register'));
    $('tabLogin').addEventListener('click', () => switchTab('login'));

    /* Theme & logout */
    $('themeBtn').addEventListener('click', switchTheme);
    $('logoutBtn').addEventListener('click', handleLogout);

    /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
    applyTheme(state.theme);
    applyI18n();

    /* Check if already logged in */
    const existingAuth = getAuth();
    if(existingAuth && existingAuth.username){
      showProfile(existingAuth);
    } else {
      switchTab('register');
    }
  </script>
</body>
</html>
