<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VocabLoop Account</title>
  <style>
    :root{
      --bg1:#dbeafe; --bg2:#dcfce7; --ink:#0f172a; --muted:#64748b;
      --pri:#2563eb; --pri2:#1d4ed8; --line:#dbe2ea; --ok:#16a34a; --err:#dc2626; --warn:#d97706;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;color:var(--ink);
      background:radial-gradient(1000px 500px at -10% -20%,#c4b5fd 0%,transparent 60%),linear-gradient(145deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:560px;margin:28px auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .back{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;text-decoration:none;color:var(--ink);font-weight:700}
    .card{background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.7);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    h1{margin:6px 0 4px;font-size:1.45rem}
    .muted{color:var(--muted);font-size:.92rem}
    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:14px 0 12px}
    .tab{border:1px solid var(--line);background:#fff;color:#334155;border-radius:10px;padding:10px;font-weight:800;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,var(--pri),var(--pri2));color:#fff;border-color:transparent}
    .panel{display:none}.panel.active{display:block}
    label{display:flex;justify-content:space-between;align-items:center;margin:10px 0 6px;font-size:.9rem;font-weight:700}
    .tiny{font-size:.75rem;color:var(--muted);font-weight:600}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);font-size:1rem;outline:none;transition:.15s}
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    input.invalid{border-color:#fca5a5;box-shadow:0 0 0 3px rgba(252,165,165,.25)}
    input.valid{border-color:#86efac;box-shadow:0 0 0 3px rgba(134,239,172,.2)}
    .hint{font-size:.82rem;color:var(--muted);margin-top:6px}
    .inline{font-size:.8rem;margin-top:5px;min-height:1.2em}
    .inline.ok{color:var(--ok)} .inline.err{color:var(--err)} .inline.warn{color:var(--warn)}
    .cta{margin-top:12px;width:100%;border:0;border-radius:10px;padding:12px;color:#fff;background:linear-gradient(180deg,var(--pri),var(--pri2));font-weight:800;cursor:pointer;transition:.15s}
    .cta:disabled{opacity:.7;cursor:not-allowed}
    .msg{margin-top:12px;padding:10px 12px;border-radius:10px;font-size:.9rem;display:none}
    .msg.ok{display:block;background:#ecfdf3;color:var(--ok);border:1px solid #bbf7d0}
    .msg.err{display:block;background:#fef2f2;color:var(--err);border:1px solid #fecaca}
    .token{margin-top:10px;padding:10px;border-radius:10px;background:#0f172a;color:#e2e8f0;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.8rem;word-break:break-all;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top"><a class="back" href="/">← Back to Home</a></div>

    <div class="card">
      <h1>Account</h1>
      <div class="muted">Create your account or login to continue learning across sessions.</div>

      <div class="tabs">
        <button id="tabRegister" class="tab active" onclick="switchTab('register')">Register</button>
        <button id="tabLogin" class="tab" onclick="switchTab('login')">Login</button>
      </div>

      <div id="panelRegister" class="panel active">
        <label for="rUser">Username <span class="tiny">min 5 chars</span></label>
        <input id="rUser" placeholder="At least 5 characters" autocomplete="username" />
        <div id="rUserHint" class="inline"></div>

        <label for="rPass">Password <span class="tiny">digits only, min 6</span></label>
        <input id="rPass" type="password" placeholder="At least 6 digits" autocomplete="new-password" />
        <div id="rPassHint" class="inline"></div>

        <label for="rPass2">Confirm Password</label>
        <input id="rPass2" type="password" placeholder="Re-enter your password" autocomplete="new-password" />
        <div id="rPass2Hint" class="inline"></div>

        <button id="registerBtn" class="cta" onclick="register()">Create Account</button>
      </div>

      <div id="panelLogin" class="panel">
        <label for="lUser">Username</label>
        <input id="lUser" placeholder="Your username" autocomplete="username" />

        <label for="lPass">Password</label>
        <input id="lPass" type="password" placeholder="Your password" autocomplete="current-password" />

        <button id="loginBtn" class="cta" onclick="login()">Login</button>
      </div>

      <div id="msg" class="msg"></div>
      <div id="token" class="token"></div>
    </div>
  </div>

  <script>
    const msg = document.getElementById('msg');
    const tokenBox = document.getElementById('token');

    const rUser = document.getElementById('rUser');
    const rPass = document.getElementById('rPass');
    const rPass2 = document.getElementById('rPass2');

    function switchTab(tab){
      const isRegister = tab === 'register';
      document.getElementById('tabRegister').classList.toggle('active', isRegister);
      document.getElementById('tabLogin').classList.toggle('active', !isRegister);
      document.getElementById('panelRegister').classList.toggle('active', isRegister);
      document.getElementById('panelLogin').classList.toggle('active', !isRegister);
      setMsg('');
      setToken('');
    }

    function setMsg(text, type=''){
      msg.className = 'msg';
      msg.textContent = text || '';
      if(!text) return;
      msg.classList.add(type === 'ok' ? 'ok' : 'err');
    }

    function setToken(token){
      if(!token){ tokenBox.style.display='none'; tokenBox.textContent=''; return; }
      tokenBox.style.display='block';
      tokenBox.textContent = `Session token:\n${token}`;
    }

    function saveAuth(user, token){
      if(!user || !user.username || !token) return;
      localStorage.setItem('vocabloop_auth', JSON.stringify({ username:user.username, token, at:Date.now() }));
    }

    function redirectHome(){ setTimeout(()=>{ window.location.href = '/'; }, 450); }

    function setInline(elId, text, type=''){
      const el = document.getElementById(elId);
      el.className = 'inline';
      el.textContent = text || '';
      if(type) el.classList.add(type);
    }

    function validateRegisterForm(){
      const u = rUser.value.trim();
      const p = rPass.value.trim();
      const p2 = rPass2.value.trim();

      let ok = true;

      if(u.length >= 5){
        setInline('rUserHint','Looks good.','ok');
        rUser.classList.add('valid'); rUser.classList.remove('invalid');
      } else {
        ok = false;
        setInline('rUserHint','Username must be at least 5 characters.','warn');
        rUser.classList.add('invalid'); rUser.classList.remove('valid');
      }

      if(/^\d{6,}$/.test(p)){
        setInline('rPassHint','Password format is valid.','ok');
        rPass.classList.add('valid'); rPass.classList.remove('invalid');
      } else {
        ok = false;
        setInline('rPassHint','Use digits only, at least 6 numbers.','warn');
        rPass.classList.add('invalid'); rPass.classList.remove('valid');
      }

      if(p2 && p === p2){
        setInline('rPass2Hint','Passwords match.','ok');
        rPass2.classList.add('valid'); rPass2.classList.remove('invalid');
      } else {
        ok = false;
        setInline('rPass2Hint','Passwords do not match yet.','err');
        rPass2.classList.add('invalid'); rPass2.classList.remove('valid');
      }

      return ok;
    }

    async function callAuth(payload){
      const r = await fetch('/api/auth', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      return r.json();
    }

    async function register(){
      if(!validateRegisterForm()){
        setMsg('Please fix the highlighted fields, then try again.');
        return;
      }

      const btn = document.getElementById('registerBtn');
      btn.disabled = true; btn.textContent = 'Creating...';

      try{
        const username = rUser.value.trim();
        const password = rPass.value.trim();
        const data = await callAuth({ action:'register', username, password });

        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg('Account created. You are now logged in — redirecting to home...','ok');
          setToken(data.token || '');
          redirectHome();
        }else{
          const m = (data.message || '').toLowerCase();
          if(m.includes('exists')){
            setMsg('This username is already taken. Try another one, or login directly.');
          }else{
            setMsg(data.message || 'Register failed. Please try again.');
          }
          setToken('');
        }
      }catch(e){
        setMsg('Network issue. Please retry in a moment.');
      }finally{
        btn.disabled = false; btn.textContent = 'Create Account';
      }
    }

    async function login(){
      const btn = document.getElementById('loginBtn');
      btn.disabled = true; btn.textContent = 'Logging in...';

      try{
        const username = document.getElementById('lUser').value.trim();
        const password = document.getElementById('lPass').value.trim();
        const data = await callAuth({ action:'login', username, password });

        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(`Welcome back, ${data.user?.username || 'user'}! Redirecting...`,'ok');
          setToken(data.token || '');
          redirectHome();
        }else{
          setMsg('Login failed. Please check username/password and try again.');
          setToken('');
        }
      }catch(e){
        setMsg('Network issue. Please retry in a moment.');
      }finally{
        btn.disabled = false; btn.textContent = 'Login';
      }
    }

    [rUser, rPass, rPass2].forEach(el => el.addEventListener('input', validateRegisterForm));
    switchTab('register');
  </script>
</body>
</html>
