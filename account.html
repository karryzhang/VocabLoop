<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VocabLoop Account</title>
  <style>
    :root{
      --bg-a:#dbeafe; --bg-b:#dcfce7; --bg-c:#ede9fe;
      --card:rgba(255,255,255,.88); --ink:#0f172a; --muted:#64748b;
      --line:#dbe2ea; --pri:#2563eb; --pri2:#1d4ed8;
      --ok:#16a34a; --err:#dc2626; --warn:#d97706;
      --shadow:0 14px 36px rgba(2,6,23,.12);
    }
    [data-theme="dark"]{
      --bg-a:#0b1220; --bg-b:#111827; --bg-c:#1e1b4b;
      --card:rgba(15,23,42,.72); --ink:#e5e7eb; --muted:#9ca3af;
      --line:#334155; --pri:#3b82f6; --pri2:#2563eb;
      --ok:#22c55e; --err:#f87171; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at -10% -20%, var(--bg-c) 0%, transparent 60%),
        linear-gradient(145deg,var(--bg-a),var(--bg-b));
      min-height:100vh;
      transition: background .25s ease, color .25s ease;
    }

    .wrap{max-width:600px;margin:24px auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
    .back,.ghost{
      border:1px solid var(--line);background:var(--card);border-radius:10px;padding:8px 12px;
      color:var(--ink);text-decoration:none;font-weight:700;cursor:pointer;
      transition: transform .12s, box-shadow .12s
    }
    .back:hover,.ghost:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .back:active,.ghost:active{transform:translateY(0);box-shadow:none}

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid color-mix(in srgb, var(--line) 60%, transparent);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    h1{margin:4px 0 6px;font-size:1.48rem;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:.92rem;line-height:1.45}

    /* â”€â”€ Tabs with sliding indicator â”€â”€ */
    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:0;margin:16px 0 12px;position:relative;
      background:color-mix(in srgb, var(--line) 35%, transparent);border-radius:14px;padding:3px}
    .tab{border:0;background:transparent;color:var(--muted);border-radius:11px;padding:11px;
      font-weight:800;cursor:pointer;transition: color .2s;position:relative;z-index:1}
    .tab.active{color:#fff}
    .tab-slider{position:absolute;top:3px;left:3px;width:calc(50% - 3px);height:calc(100% - 6px);
      background:linear-gradient(180deg,var(--pri),var(--pri2));border-radius:11px;
      transition:transform .28s cubic-bezier(.4,0,.2,1);
      box-shadow:0 4px 14px color-mix(in srgb, var(--pri) 35%, transparent);z-index:0}
    .tab-slider.right{transform:translateX(100%)}

    /* â”€â”€ Panel transitions â”€â”€ */
    .panels{position:relative;overflow:hidden}
    .panel{display:none;animation:panelIn .25s ease}
    .panel.active{display:block}
    @keyframes panelIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    label{display:flex;justify-content:space-between;align-items:center;margin:11px 0 6px;font-size:.92rem;font-weight:700}
    .tiny{font-size:.75rem;color:var(--muted);font-weight:600}

    .input-wrap{position:relative}
    input{
      width:100%;padding:12px 42px 12px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:1rem;outline:none;background:transparent;color:var(--ink);transition:.15s
    }
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px color-mix(in srgb, #93c5fd 32%, transparent)}
    input.invalid{border-color:color-mix(in srgb, var(--err) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--err) 20%, transparent)}
    input.valid{border-color:color-mix(in srgb, var(--ok) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--ok) 20%, transparent)}

    .toggle-eye{
      position:absolute;right:9px;top:50%;transform:translateY(-50%);
      border:0;background:transparent;color:var(--muted);cursor:pointer;font-size:1rem;
      transition:color .15s
    }
    .toggle-eye:hover{color:var(--ink)}

    /* â”€â”€ Password strength meter â”€â”€ */
    .strength-bar{height:4px;border-radius:2px;background:var(--line);margin-top:6px;overflow:hidden}
    .strength-fill{height:100%;width:0;border-radius:2px;transition:width .3s ease,background .3s ease}
    .strength-fill.s1{width:33%;background:var(--err)}
    .strength-fill.s2{width:66%;background:var(--warn)}
    .strength-fill.s3{width:100%;background:var(--ok)}

    .inline{font-size:.82rem;margin-top:6px;min-height:1.2em;line-height:1.35;
      transition:opacity .2s}
    .inline.ok{color:var(--ok)} .inline.err{color:var(--err)} .inline.warn{color:var(--warn)}

    /* â”€â”€ CTA buttons â”€â”€ */
    .cta{
      margin-top:16px;width:100%;border:0;border-radius:12px;padding:13px;
      color:#fff;background:linear-gradient(180deg,var(--pri),var(--pri2));font-weight:800;cursor:pointer;
      font-size:.95rem;letter-spacing:.3px;
      transition: transform .12s, box-shadow .15s, opacity .15s;
      box-shadow:0 8px 18px color-mix(in srgb, var(--pri) 36%, transparent);
      display:flex;align-items:center;justify-content:center;gap:8px
    }
    .cta:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 10px 24px color-mix(in srgb, var(--pri) 45%, transparent)}
    .cta:active:not(:disabled){transform:translateY(1px);box-shadow:0 4px 10px color-mix(in srgb, var(--pri) 25%, transparent)}
    .cta:disabled{opacity:.65;cursor:not-allowed}

    /* â”€â”€ Spinner â”€â”€ */
    .spinner{display:none;width:18px;height:18px;border:2.5px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    .cta.loading .spinner{display:block}
    .cta.loading .btn-text{opacity:.8}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ Message box â”€â”€ */
    .msg{margin-top:12px;padding:10px 12px;border-radius:11px;font-size:.92rem;
      display:none;align-items:center;gap:8px;animation:msgIn .25s ease}
    .msg.ok{display:flex;background:color-mix(in srgb, var(--ok) 13%, transparent);color:var(--ok);
      border:1px solid color-mix(in srgb, var(--ok) 40%, transparent)}
    .msg.err{display:flex;background:color-mix(in srgb, var(--err) 12%, transparent);color:var(--err);
      border:1px solid color-mix(in srgb, var(--err) 40%, transparent)}
    .msg-icon{font-size:1.1rem;flex-shrink:0}
    @keyframes msgIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

    /* â”€â”€ Shake on error â”€â”€ */
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .shake{animation:shake .4s ease}

    /* â”€â”€ Success overlay â”€â”€ */
    .success-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.35);backdrop-filter:blur(4px);z-index:100;opacity:0;
      transition:opacity .3s ease;pointer-events:none}
    .success-overlay.show{opacity:1;pointer-events:auto}
    .success-check{width:80px;height:80px;border-radius:50%;
      background:linear-gradient(135deg,var(--ok),#16a34a);
      display:flex;align-items:center;justify-content:center;
      transform:scale(0);transition:transform .35s cubic-bezier(.34,1.56,.64,1)}
    .success-overlay.show .success-check{transform:scale(1)}
    .success-check svg{width:44px;height:44px}
    .check-path{stroke-dasharray:50;stroke-dashoffset:50;animation:drawCheck .4s .3s ease forwards}
    @keyframes drawCheck{to{stroke-dashoffset:0}}

    /* â”€â”€ Offline mode panel â”€â”€ */
    .offline-panel{text-align:center;padding:24px 0}
    .offline-icon{font-size:2.4rem;margin-bottom:10px}
    .offline-title{font-size:1.2rem;font-weight:800;margin-bottom:8px}
    .offline-desc{color:var(--muted);font-size:.92rem;line-height:1.55;margin-bottom:20px}
    .offline-features{text-align:left;margin:16px 0 20px;padding:14px;
      background:color-mix(in srgb, var(--pri) 6%, transparent);border-radius:12px;
      border:1px solid color-mix(in srgb, var(--pri) 15%, transparent)}
    .offline-features li{color:var(--muted);font-size:.88rem;margin:6px 0;line-height:1.4}
    .offline-features li strong{color:var(--ink)}

    /* â”€â”€ Logged-in profile panel â”€â”€ */
    .profile{text-align:center;padding:16px 0}
    .profile-avatar{width:72px;height:72px;border-radius:50%;
      background:linear-gradient(135deg,var(--pri),#8b5cf6);
      display:inline-flex;align-items:center;justify-content:center;
      font-size:2rem;color:#fff;font-weight:700;margin-bottom:12px}
    .profile-name{font-size:1.3rem;font-weight:800;margin-bottom:4px}
    .profile-meta{color:var(--muted);font-size:.88rem;margin-bottom:16px}
    .btn-logout{border:1px solid var(--err);background:transparent;color:var(--err);border-radius:12px;
      padding:10px 24px;font-weight:700;cursor:pointer;transition:.15s;font-size:.92rem}
    .btn-logout:hover{background:color-mix(in srgb, var(--err) 10%, transparent)}

    /* â”€â”€ Data management buttons â”€â”€ */
    .data-section{margin-top:20px;padding-top:16px;border-top:1px solid var(--line)}
    .data-section h3{margin:0 0 10px;font-size:.95rem;font-weight:700}
    .data-btns{display:flex;gap:10px}
    .btn-data{flex:1;border:1px solid var(--line);background:var(--card);color:var(--ink);border-radius:12px;
      padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s;font-size:.88rem;
      display:flex;align-items:center;justify-content:center;gap:6px}
    .btn-data:hover{background:color-mix(in srgb, var(--pri) 8%, var(--card));border-color:var(--pri)}
    .btn-data:active{transform:translateY(1px)}
    .btn-data svg{width:16px;height:16px;flex-shrink:0}

    /* â”€â”€ Toast â”€â”€ */
    .toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(80px);
      background:var(--ink);color:var(--card);padding:10px 20px;border-radius:12px;
      font-size:.88rem;font-weight:600;opacity:0;transition:all .3s ease;z-index:200;pointer-events:none;
      white-space:nowrap}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    @media (max-width: 520px){
      .wrap{margin:12px auto}
      .card{padding:14px}
      h1{font-size:1.3rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="./" id="backBtn">â† Back to Home</a>
      <button class="ghost" id="themeBtn">ğŸŒ“ Theme</button>
    </div>

    <div class="card">
      <!-- Logged-in profile view -->
      <div id="profilePanel" class="profile" style="display:none">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-name" id="profileName">username</div>
        <div class="profile-meta" id="profileMeta">Logged in</div>
        <div class="data-section">
          <h3 id="dataTitle">Data</h3>
          <div class="data-btns">
            <button class="btn-data" id="exportBtn" onclick="exportProgress()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              <span id="exportLabel">Export</span>
            </button>
            <button class="btn-data" id="importBtnEl" onclick="document.getElementById('importFileInput').click()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              <span id="importLabel">Import</span>
            </button>
          </div>
        </div>
        <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
        <div style="height:12px"></div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>

      <!-- Offline mode (no backend) -->
      <div id="offlinePanel" style="display:none">
        <div class="offline-panel">
          <div class="offline-icon">ğŸ“´</div>
          <div class="offline-title" id="offlineTitle">Offline Mode</div>
          <div class="offline-desc" id="offlineDesc">You're using VocabLoop as a static page â€” no server is connected. Your learning data is stored locally in this browser.</div>
          <ul class="offline-features" id="offlineFeatures">
            <li id="offlineFeat1"><strong>All learning features</strong> work normally without an account</li>
            <li id="offlineFeat2">Use <strong>Export / Import</strong> below to back up or transfer your progress</li>
            <li id="offlineFeat3">Deploy with a Node.js backend to enable <strong>cloud sync</strong> across devices</li>
          </ul>
          <div class="data-section" style="border-top:none;margin-top:0;padding-top:0">
            <div class="data-btns">
              <button class="btn-data" onclick="exportProgress()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span id="offlineExportLabel">Export</span>
              </button>
              <button class="btn-data" onclick="document.getElementById('offlineImportInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <span id="offlineImportLabel">Import</span>
              </button>
            </div>
          </div>
          <input type="file" id="offlineImportInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
        </div>
      </div>

      <!-- Auth form view (hidden until backend detected) -->
      <div id="authPanel" style="display:none">
        <h1 id="title">Account</h1>
        <div class="muted" id="subtitle">Create your account or login to continue learning across sessions.</div>

        <div class="tabs">
          <button id="tabRegister" class="tab active">Register</button>
          <button id="tabLogin" class="tab">Login</button>
          <div class="tab-slider" id="tabSlider"></div>
        </div>

        <div class="panels">
          <div id="panelRegister" class="panel active">
            <form id="registerForm" autocomplete="on" novalidate>
              <label for="rUser"><span id="labelUser">Username</span> <span class="tiny" id="ruleUser">min 5 chars</span></label>
              <div class="input-wrap"><input id="rUser" placeholder="At least 5 characters" autocomplete="username" /></div>
              <div id="rUserHint" class="inline"></div>

              <label for="rPass"><span id="labelPass">Password</span> <span class="tiny" id="rulePass">digits only, min 6</span></label>
              <div class="input-wrap">
                <input id="rPass" type="password" inputmode="numeric" placeholder="At least 6 digits" autocomplete="new-password" />
                <button type="button" class="toggle-eye" data-target="rPass">ğŸ‘ï¸</button>
              </div>
              <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
              <div id="rPassHint" class="inline"></div>

              <label for="rPass2" id="labelPass2">Confirm Password</label>
              <div class="input-wrap">
                <input id="rPass2" type="password" inputmode="numeric" placeholder="Re-enter your password" autocomplete="new-password" />
                <button type="button" class="toggle-eye" data-target="rPass2">ğŸ‘ï¸</button>
              </div>
              <div id="rPass2Hint" class="inline"></div>

              <button type="submit" id="registerBtn" class="cta">
                <span class="btn-text">Create Account</span>
                <span class="spinner"></span>
              </button>
            </form>
          </div>

          <div id="panelLogin" class="panel">
            <form id="loginForm" autocomplete="on" novalidate>
              <label for="lUser" id="lUserLabel">Username</label>
              <div class="input-wrap"><input id="lUser" placeholder="Your username" autocomplete="username" /></div>

              <label for="lPass" id="lPassLabel">Password</label>
              <div class="input-wrap">
                <input id="lPass" type="password" inputmode="numeric" placeholder="Your password" autocomplete="current-password" />
                <button type="button" class="toggle-eye" data-target="lPass">ğŸ‘ï¸</button>
              </div>

              <button type="submit" id="loginBtn" class="cta">
                <span class="btn-text">Login</span>
                <span class="spinner"></span>
              </button>
            </form>
          </div>
        </div>

        <div id="msg" class="msg"><span class="msg-icon"></span><span class="msg-text"></span></div>
      </div>
    </div>
  </div>

  <!-- Success overlay -->
  <div class="success-overlay" id="successOverlay">
    <div class="success-check">
      <svg viewBox="0 0 44 44" fill="none">
        <path class="check-path" d="M10 22 L19 31 L34 14" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const I18N = {
      en: {
        back:'â† Back to Home', theme:'ğŸŒ“ Theme', title:'Account',
        subtitle:'Create your account or login to continue learning across sessions.',
        register:'Register', login:'Login',
        username:'Username', userRule:'min 5 chars',
        password:'Password', passRule:'digits only, min 6',
        confirm:'Confirm Password',
        phUser:'At least 5 characters', phPass:'At least 6 digits', phPass2:'Re-enter your password',
        loginUser:'Your username', loginPass:'Your password',
        create:'Create Account', creating:'Creating...',
        loginBtn:'Login', logging:'Logging in...',
        hUserOk:'Looks good.', hUserBad:'Username must be at least 5 characters.',
        hPassOk:'Password format is valid.', hPassBad:'Use digits only, at least 6 numbers.',
        hPass2Ok:'Passwords match.', hPass2Bad:'Passwords do not match yet.',
        fixFields:'Please fix the highlighted fields, then try again.',
        registerOk:'Account created. You are now logged in!',
        registerTaken:'This username is already taken. Try another one, or login directly.',
        registerFail:'Register failed. Please try again.',
        loginOk:(u)=>`Welcome back, ${u}!`,
        loginFail:'Login failed. Please check username/password and try again.',
        network:'Network issue. Please retry in a moment.',
        loggedIn:'Logged in',
        logout:'Logout',
        logoutConfirm:'Are you sure you want to logout?',
        strengthWeak:'Weak', strengthMedium:'Medium', strengthStrong:'Strong',
        exportBtn:'Export', importBtn:'Import',
        importConfirm:'Import learning records from file.\nExisting words will be smart-merged (keeping the more recently reviewed version). No data will be lost.\n\nProceed?',
        importOk:(n)=>`Imported! Merged data from ${n} deck${n===1?'':'s'}`,
        importFail:'Import failed: invalid file format',
        importEmpty:'No learning records found in file',
        exportOk:'Export âœ“',
        offlineTitle:'Offline Mode',
        offlineDesc:'You\'re using VocabLoop as a static page â€” no server is connected. Your learning data is stored locally in this browser.',
        offlineFeat1:'<strong>All learning features</strong> work normally without an account',
        offlineFeat2:'Use <strong>Export / Import</strong> below to back up or transfer your progress',
        offlineFeat3:'Deploy with a Node.js backend to enable <strong>cloud sync</strong> across devices'
      },
      zh: {
        back:'â† è¿”å›é¦–é¡µ', theme:'ğŸŒ“ ä¸»é¢˜', title:'è´¦æˆ·',
        subtitle:'åˆ›å»ºæ–°è´¦å·æˆ–ç™»å½•ï¼Œç»§ç»­ä½ çš„å­¦ä¹ è¿›åº¦ã€‚',
        register:'æ³¨å†Œ', login:'ç™»å½•',
        username:'ç”¨æˆ·å', userRule:'è‡³å°‘5ä¸ªå­—ç¬¦',
        password:'å¯†ç ', passRule:'ä»…æ•°å­—ï¼Œè‡³å°‘6ä½',
        confirm:'ç¡®è®¤å¯†ç ',
        phUser:'è‡³å°‘5ä¸ªå­—ç¬¦', phPass:'è‡³å°‘6ä½æ•°å­—', phPass2:'å†æ¬¡è¾“å…¥å¯†ç ',
        loginUser:'è¯·è¾“å…¥ç”¨æˆ·å', loginPass:'è¯·è¾“å…¥å¯†ç ',
        create:'åˆ›å»ºè´¦å·', creating:'åˆ›å»ºä¸­...',
        loginBtn:'ç™»å½•', logging:'ç™»å½•ä¸­...',
        hUserOk:'ç”¨æˆ·åå¯ç”¨ã€‚', hUserBad:'ç”¨æˆ·åè‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦ã€‚',
        hPassOk:'å¯†ç æ ¼å¼æ­£ç¡®ã€‚', hPassBad:'å¯†ç éœ€ä¸ºè‡³å°‘6ä½æ•°å­—ã€‚',
        hPass2Ok:'ä¸¤æ¬¡å¯†ç ä¸€è‡´ã€‚', hPass2Bad:'ä¸¤æ¬¡å¯†ç æš‚æœªä¸€è‡´ã€‚',
        fixFields:'è¯·å…ˆä¿®æ­£é«˜äº®å­—æ®µåå†æäº¤ã€‚',
        registerOk:'æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•ï¼',
        registerTaken:'è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œå»ºè®®æ›´æ¢æˆ–ç›´æ¥ç™»å½•ã€‚',
        registerFail:'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚',
        loginOk:(u)=>`æ¬¢è¿å›æ¥ï¼Œ${u}ï¼`,
        loginFail:'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæˆ–å¯†ç ã€‚',
        network:'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚',
        loggedIn:'å·²ç™»å½•',
        logout:'é€€å‡ºç™»å½•',
        logoutConfirm:'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
        strengthWeak:'å¼±', strengthMedium:'ä¸­', strengthStrong:'å¼º',
        exportBtn:'å¯¼å‡º', importBtn:'å¯¼å…¥',
        importConfirm:'å°†ä»æ–‡ä»¶ä¸­å¯¼å…¥å­¦ä¹ è®°å½•ã€‚\nå·²æœ‰çš„å•è¯å°†æ™ºèƒ½åˆå¹¶ï¼ˆä¿ç•™å¤ä¹ æ›´è¿‘çš„ç‰ˆæœ¬ï¼‰ï¼Œä¸ä¼šä¸¢å¤±ç°æœ‰è¿›åº¦ã€‚\n\nç¡®å®šå¯¼å…¥å—ï¼Ÿ',
        importOk:(n)=>`å¯¼å…¥æˆåŠŸï¼å·²åˆå¹¶ ${n} ä¸ªè¯åº“çš„æ•°æ®`,
        importFail:'å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®',
        importEmpty:'æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å­¦ä¹ è®°å½•',
        exportOk:'å¯¼å‡º âœ“',
        offlineTitle:'ç¦»çº¿æ¨¡å¼',
        offlineDesc:'å½“å‰ä»¥é™æ€é¡µé¢è¿è¡Œï¼Œæœªè¿æ¥æœåŠ¡ç«¯ã€‚ä½ çš„å­¦ä¹ æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚',
        offlineFeat1:'<strong>æ‰€æœ‰å­¦ä¹ åŠŸèƒ½</strong>æ— éœ€è´¦å·å³å¯æ­£å¸¸ä½¿ç”¨',
        offlineFeat2:'ä½¿ç”¨ä¸‹æ–¹çš„<strong>å¯¼å‡º/å¯¼å…¥</strong>å¯å¤‡ä»½æˆ–è¿ç§»å­¦ä¹ è¿›åº¦',
        offlineFeat3:'éƒ¨ç½² Node.js åç«¯å³å¯å¼€å¯<strong>è·¨è®¾å¤‡äº‘åŒæ­¥</strong>'
      }
    };

    const state = {
      lang: (navigator.language || '').toLowerCase().startsWith('zh') ? 'zh' : 'en',
      t: null,
      theme: localStorage.getItem('vocabloop_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
      currentTab: 'register',
      touched: { rUser: false, rPass: false, rPass2: false }
    };

    /* â”€â”€ DOM refs â”€â”€ */
    const $ = id => document.getElementById(id);
    const msgEl = $('msg');
    const rUser = $('rUser');
    const rPass = $('rPass');
    const rPass2 = $('rPass2');

    /* â”€â”€ Theme â”€â”€ */
    function applyTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('vocabloop_theme', theme);
    }
    function switchTheme(){ applyTheme(state.theme === 'dark' ? 'light' : 'dark'); }

    /* â”€â”€ i18n â”€â”€ */
    function applyI18n(){
      state.t = I18N[state.lang] || I18N.en;
      const t = state.t;
      document.documentElement.lang = state.lang === 'zh' ? 'zh-CN' : 'en';
      $('backBtn').textContent = t.back;
      $('themeBtn').textContent = t.theme;
      $('title').textContent = t.title;
      $('subtitle').textContent = t.subtitle;
      $('tabRegister').textContent = t.register;
      $('tabLogin').textContent = t.login;
      $('labelUser').textContent = t.username;
      $('ruleUser').textContent = t.userRule;
      $('labelPass').textContent = t.password;
      $('rulePass').textContent = t.passRule;
      $('labelPass2').textContent = t.confirm;
      $('lUserLabel').textContent = t.username;
      $('lPassLabel').textContent = t.password;
      $('registerBtn').querySelector('.btn-text').textContent = t.create;
      $('loginBtn').querySelector('.btn-text').textContent = t.loginBtn;
      rUser.placeholder = t.phUser; rPass.placeholder = t.phPass; rPass2.placeholder = t.phPass2;
      $('lUser').placeholder = t.loginUser;
      $('lPass').placeholder = t.loginPass;
      $('logoutBtn').textContent = t.logout;
      $('exportLabel').textContent = t.exportBtn;
      $('importLabel').textContent = t.importBtn;
      $('dataTitle').textContent = state.lang === 'zh' ? 'æ•°æ®ç®¡ç†' : 'Data';
      /* Offline panel i18n */
      $('offlineTitle').textContent = t.offlineTitle;
      $('offlineDesc').textContent = t.offlineDesc;
      $('offlineFeat1').innerHTML = t.offlineFeat1;
      $('offlineFeat2').innerHTML = t.offlineFeat2;
      $('offlineFeat3').innerHTML = t.offlineFeat3;
      $('offlineExportLabel').textContent = t.exportBtn;
      $('offlineImportLabel').textContent = t.importBtn;
    }

    /* â”€â”€ Tab switching with sliding indicator â”€â”€ */
    function switchTab(tab){
      state.currentTab = tab;
      const isRegister = tab === 'register';
      $('tabRegister').classList.toggle('active', isRegister);
      $('tabLogin').classList.toggle('active', !isRegister);
      $('tabSlider').classList.toggle('right', !isRegister);
      $('panelRegister').classList.toggle('active', isRegister);
      $('panelLogin').classList.toggle('active', !isRegister);
      setMsg('', '');
      /* Auto-focus first input */
      setTimeout(() => {
        const target = isRegister ? rUser : $('lUser');
        target.focus();
      }, 280);
    }

    /* â”€â”€ Password toggle â”€â”€ */
    document.querySelectorAll('.toggle-eye').forEach(btn => {
      btn.addEventListener('click', function(){
        const input = $(this.dataset.target);
        input.type = input.type === 'password' ? 'text' : 'password';
        this.textContent = input.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
      });
    });

    /* â”€â”€ Message display â”€â”€ */
    function setMsg(text, type){
      msgEl.className = 'msg';
      const iconEl = msgEl.querySelector('.msg-icon');
      const textEl = msgEl.querySelector('.msg-text');
      textEl.textContent = text || '';
      if(!text){ iconEl.textContent = ''; return; }
      iconEl.textContent = type === 'ok' ? 'âœ“' : 'âœ•';
      msgEl.classList.add(type === 'ok' ? 'ok' : 'err');
    }

    /* â”€â”€ Auth persistence â”€â”€ */
    function saveAuth(user, token){
      if(!user || !user.username || !token) return;
      localStorage.setItem('vocabloop_auth', JSON.stringify({ username:user.username, token, at:Date.now() }));
    }
    function getAuth(){
      try{ return JSON.parse(localStorage.getItem('vocabloop_auth')); }catch(e){ return null; }
    }
    function clearAuth(){ localStorage.removeItem('vocabloop_auth'); }

    /* â”€â”€ Success overlay + redirect with cloud sync â”€â”€ */
    async function showSuccessAndRedirect(){
      const overlay = $('successOverlay');
      overlay.classList.add('show');
      /* Trigger a merge sync so cloud data is pulled before redirect */
      try{ await syncOnAuth(); }catch(e){ /* non-blocking: redirect even if sync fails */ }
      setTimeout(() => {
        /* Use relative path so it works on GitHub Pages subdirectory */
        const base = window.location.pathname.replace(/account\.html.*$/, '');
        window.location.href = base || '/';
      }, 1200);
    }

    /** Sync learning data with cloud on login/register */
    async function syncOnAuth(){
      const auth = getAuth();
      if(!auth || !auth.token) return;
      try{
        /* Collect all local learning data */
        const DECK_IDS = ['pet', 'daily', 'ielts', 'crypto'];
        const decks = {};
        for(const id of DECK_IDS){
          try{
            const raw = localStorage.getItem('srs_' + id + '_v1');
            if(raw) decks[id] = JSON.parse(raw);
          }catch(e){}
        }
        let global = {};
        try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) global = JSON.parse(raw); }catch(e){}
        let readingHistory = [];
        try{ const raw = localStorage.getItem('reading_history'); if(raw) readingHistory = JSON.parse(raw); }catch(e){}

        const localData = {
          decks: decks,
          global: global,
          preferredDeck: localStorage.getItem('preferred_deck') || '',
          readingHistory: readingHistory,
        };

        const r = await fetch('/api/sync', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ action:'merge', token:auth.token, data:localData })
        });
        const result = await r.json();

        /* Apply merged data back to localStorage */
        if(result.ok && result.data){
          const d = result.data;
          if(d.decks){
            for(const id of DECK_IDS){
              if(d.decks[id]) try{ localStorage.setItem('srs_'+id+'_v1', JSON.stringify(d.decks[id])); }catch(e){}
            }
          }
          if(d.global) try{ localStorage.setItem('srs_global_v1', JSON.stringify(d.global)); }catch(e){}
          if(d.preferredDeck) try{ localStorage.setItem('preferred_deck', d.preferredDeck); }catch(e){}
          if(Array.isArray(d.readingHistory)) try{ localStorage.setItem('reading_history', JSON.stringify(d.readingHistory)); }catch(e){}
          try{ localStorage.setItem('vocabloop_sync_ts', String(Date.now())); }catch(e){}
        }
      }catch(e){ /* ignore sync errors â€” don't block redirect */ }
    }

    /* â”€â”€ Toast â”€â”€ */
    function showToast(msg){
      const el = $('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._tid);
      el._tid = setTimeout(() => el.classList.remove('show'), 2200);
    }

    /* â”€â”€ Export / Import â”€â”€ */
    const DECK_IDS = ['pet', 'daily', 'ielts', 'crypto'];

    function today(){
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    function exportProgress(){
      const t = state.t;
      const allState = {};
      for(const id of DECK_IDS){
        try{ const raw = localStorage.getItem('srs_'+id+'_v1'); if(raw) allState[id] = JSON.parse(raw); }catch(e){}
      }
      let global = {};
      try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) global = JSON.parse(raw); }catch(e){}
      let readingHistory = [];
      try{ const raw = localStorage.getItem('reading_history'); if(raw) readingHistory = JSON.parse(raw); }catch(e){}
      const data = {
        version: 1,
        exportDate: new Date().toISOString(),
        global: global,
        decks: allState,
        preferredDeck: localStorage.getItem('preferred_deck') || '',
        readingHistory: readingHistory,
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vocabloop-backup-' + today() + '.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast(t.exportOk);
    }

    function handleImportFile(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const data = JSON.parse(ev.target.result);
          importProgress(data);
        }catch(err){
          showToast(state.t.importFail);
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    }

    function importProgress(data){
      const t = state.t;
      if(!data || typeof data !== 'object' || !data.decks){
        showToast(t.importFail); return;
      }
      if(!confirm(t.importConfirm)) return;

      let mergedCount = 0;
      for(const id of DECK_IDS){
        const importedDeck = data.decks[id];
        if(!importedDeck) continue;
        const importedState = importedDeck.state || {};
        if(Object.keys(importedState).length === 0) continue;

        let localDeck = {};
        try{ const raw = localStorage.getItem('srs_'+id+'_v1'); if(raw) localDeck = JSON.parse(raw); }catch(e){}
        const localState = localDeck.state || {};

        const merged = {};
        const allWords = new Set([...Object.keys(localState), ...Object.keys(importedState)]);
        for(const word of allWords){
          const l = localState[word];
          const c = importedState[word];
          if(!l){ merged[word] = c; continue; }
          if(!c){ merged[word] = l; continue; }
          merged[word] = (l.next||0) >= (c.next||0) ? l : c;
        }
        const mergedDeck = {
          state: merged,
          points: Math.max(localDeck.points||0, importedDeck.points||0),
          streak: Math.max(localDeck.streak||0, importedDeck.streak||0),
          autoPlay: localDeck.autoPlay !== undefined ? localDeck.autoPlay : importedDeck.autoPlay,
        };
        try{ localStorage.setItem('srs_'+id+'_v1', JSON.stringify(mergedDeck)); }catch(e){}
        mergedCount++;
      }

      if(data.global){
        let g = data.global;
        let local = {};
        try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) local = JSON.parse(raw); }catch(e){}
        local.dailyStreak   = Math.max(local.dailyStreak||0, g.dailyStreak||0);
        local.lastStudyDate = (local.lastStudyDate||'') >= (g.lastStudyDate||'') ? local.lastStudyDate : g.lastStudyDate;
        local.totalReviewed = Math.max(local.totalReviewed||0, g.totalReviewed||0);
        if(Array.isArray(g.achievements)){
          local.achievements = [...new Set([...(local.achievements||[]), ...g.achievements])];
        }
        try{ localStorage.setItem('srs_global_v1', JSON.stringify(local)); }catch(e){}
      }

      if(Array.isArray(data.readingHistory) && data.readingHistory.length > 0){
        let existing = [];
        try{ const raw = localStorage.getItem('reading_history'); if(raw) existing = JSON.parse(raw); }catch(e){}
        const seen = new Set();
        const merged = [];
        for(const item of [...existing, ...data.readingHistory]){
          const key = JSON.stringify(item);
          if(!seen.has(key)){ seen.add(key); merged.push(item); }
        }
        try{ localStorage.setItem('reading_history', JSON.stringify(merged.slice(-50))); }catch(e){}
      }

      if(mergedCount > 0){
        showToast(t.importOk(mergedCount));
      } else {
        showToast(t.importEmpty);
      }
    }

    /* â”€â”€ Shake animation helper â”€â”€ */
    function shakeEl(el){
      el.classList.remove('shake');
      void el.offsetWidth;
      el.classList.add('shake');
    }

    /* â”€â”€ Inline hints â”€â”€ */
    function setInline(elId, text, type){
      const el = $(elId);
      el.className = 'inline';
      el.textContent = text || '';
      if(type) el.classList.add(type);
    }

    /* â”€â”€ Password strength meter â”€â”€ */
    function updateStrength(val){
      const fill = $('strengthFill');
      fill.className = 'strength-fill';
      if(!val){ return; }
      const digits = val.replace(/\D/g, '');
      if(digits.length >= 10) fill.classList.add('s3');
      else if(digits.length >= 6) fill.classList.add('s2');
      else if(digits.length >= 1) fill.classList.add('s1');
    }

    /* â”€â”€ Register validation (only validates touched fields) â”€â”€ */
    function validateRegisterForm(submitAttempt){
      const t = state.t;
      const u = rUser.value.trim();
      const p = rPass.value.trim();
      const p2 = rPass2.value.trim();
      let ok = true;

      /* Username */
      if(state.touched.rUser || submitAttempt){
        if(u.length >= 5){
          setInline('rUserHint',t.hUserOk,'ok'); rUser.classList.add('valid'); rUser.classList.remove('invalid');
        } else {
          ok = false; setInline('rUserHint',t.hUserBad,'warn'); rUser.classList.add('invalid'); rUser.classList.remove('valid');
        }
      } else if(u.length < 5) ok = false;

      /* Password */
      if(state.touched.rPass || submitAttempt){
        if(/^\d{6,}$/.test(p)){
          setInline('rPassHint',t.hPassOk,'ok'); rPass.classList.add('valid'); rPass.classList.remove('invalid');
        } else {
          ok = false; setInline('rPassHint',t.hPassBad,'warn'); rPass.classList.add('invalid'); rPass.classList.remove('valid');
        }
      } else if(!/^\d{6,}$/.test(p)) ok = false;

      /* Confirm password */
      if(state.touched.rPass2 || submitAttempt){
        if(p2 && p === p2){
          setInline('rPass2Hint',t.hPass2Ok,'ok'); rPass2.classList.add('valid'); rPass2.classList.remove('invalid');
        } else {
          ok = false; setInline('rPass2Hint',t.hPass2Bad,'err'); rPass2.classList.add('invalid'); rPass2.classList.remove('valid');
        }
      } else if(!p2 || p !== p2) ok = false;

      updateStrength(p);
      return ok;
    }

    /* â”€â”€ Set button loading state â”€â”€ */
    function setBtnLoading(btn, loading, text){
      btn.disabled = loading;
      btn.classList.toggle('loading', loading);
      btn.querySelector('.btn-text').textContent = text;
    }

    /* â”€â”€ API call â”€â”€ */
    async function callAuth(payload){
      const r = await fetch('/api/auth', {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)
      });
      return r.json();
    }

    /* â”€â”€ Register â”€â”€ */
    async function register(){
      const t = state.t;
      /* Mark all fields as touched on submit attempt */
      state.touched.rUser = state.touched.rPass = state.touched.rPass2 = true;
      if(!validateRegisterForm(true)){
        setMsg(t.fixFields, 'err');
        shakeEl($('registerBtn'));
        return;
      }
      const btn = $('registerBtn');
      setBtnLoading(btn, true, t.creating);
      try{
        const data = await callAuth({ action:'register', username:rUser.value.trim(), password:rPass.value.trim() });
        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(t.registerOk, 'ok');
          showSuccessAndRedirect();
        } else {
          const m = (data.message || '').toLowerCase();
          if(m.includes('exists')) setMsg(t.registerTaken, 'err');
          else setMsg(data.message || t.registerFail, 'err');
          shakeEl(btn);
        }
      }catch(_){ setMsg(t.network, 'err'); shakeEl(btn); }
      finally { setBtnLoading(btn, false, t.create); }
    }

    /* â”€â”€ Login â”€â”€ */
    async function login(){
      const t = state.t;
      const btn = $('loginBtn');
      const uVal = $('lUser').value.trim();
      const pVal = $('lPass').value.trim();
      if(!uVal || !pVal){
        setMsg(t.fixFields, 'err'); shakeEl(btn); return;
      }
      setBtnLoading(btn, true, t.logging);
      try{
        const data = await callAuth({ action:'login', username:uVal, password:pVal });
        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(t.loginOk(data.user?.username || 'user'), 'ok');
          showSuccessAndRedirect();
        } else { setMsg(t.loginFail, 'err'); shakeEl(btn); }
      }catch(_){ setMsg(t.network, 'err'); shakeEl(btn); }
      finally { setBtnLoading(btn, false, t.loginBtn); }
    }

    /* â”€â”€ Logged-in profile view â”€â”€ */
    function showProfile(auth){
      $('authPanel').style.display = 'none';
      $('profilePanel').style.display = 'block';
      const name = auth.username || 'User';
      $('profileAvatar').textContent = name.charAt(0).toUpperCase();
      $('profileName').textContent = name;
      $('profileMeta').textContent = state.t.loggedIn;
    }

    function handleLogout(){
      if(!confirm(state.t.logoutConfirm)) return;
      clearAuth();
      $('authPanel').style.display = 'block';
      $('profilePanel').style.display = 'none';
      switchTab('login');
    }

    /* â”€â”€ Event listeners â”€â”€ */
    /* Track which fields user has touched for gentle validation */
    rUser.addEventListener('focus', () => { state.touched.rUser = true; });
    rPass.addEventListener('focus', () => { state.touched.rPass = true; });
    rPass2.addEventListener('focus', () => { state.touched.rPass2 = true; });
    [rUser, rPass, rPass2].forEach(el => el.addEventListener('input', () => validateRegisterForm(false)));

    /* Form submit via Enter key */
    $('registerForm').addEventListener('submit', e => { e.preventDefault(); register(); });
    $('loginForm').addEventListener('submit', e => { e.preventDefault(); login(); });

    /* Tab buttons */
    $('tabRegister').addEventListener('click', () => switchTab('register'));
    $('tabLogin').addEventListener('click', () => switchTab('login'));

    /* Theme & logout */
    $('themeBtn').addEventListener('click', switchTheme);
    $('logoutBtn').addEventListener('click', handleLogout);

    /* â”€â”€ Backend detection â”€â”€ */
    async function checkBackend(){
      try{
        const base = window.location.pathname.replace(/account\.html.*$/, '');
        const res = await fetch(base + 'api/auth', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ action: 'ping' }),
        });
        const ct = (res.headers.get('content-type') || '');
        if(ct.includes('application/json') || ct.includes('text/json')){
          const data = await res.json();
          return !!(data && data.ok === true && data.message === 'pong');
        }
      }catch(_){}
      return false;
    }

    function showOfflineMode(){
      $('authPanel').style.display = 'none';
      $('profilePanel').style.display = 'none';
      $('offlinePanel').style.display = 'block';
    }

    /* â”€â”€ Init â”€â”€ */
    applyTheme(state.theme);
    applyI18n();

    /* Detect backend, then show appropriate view */
    checkBackend().then(function(available){
      if(!available){
        showOfflineMode();
        return;
      }
      /* Backend available â€” normal flow */
      const existingAuth = getAuth();
      if(existingAuth && existingAuth.username){
        showProfile(existingAuth);
      } else {
        $('authPanel').style.display = 'block';
        switchTab('register');
      }
    });
  </script>
</body>
</html>
