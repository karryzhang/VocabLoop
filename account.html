<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VocabLoop Account</title>
  <style>
    :root{
      --bg-a:#dbeafe; --bg-b:#dcfce7; --bg-c:#ede9fe;
      --card:rgba(255,255,255,.88); --ink:#0f172a; --muted:#64748b;
      --line:#dbe2ea; --pri:#2563eb; --pri2:#1d4ed8;
      --ok:#16a34a; --err:#dc2626; --warn:#d97706;
      --shadow:0 14px 36px rgba(2,6,23,.12);
    }
    [data-theme="dark"]{
      --bg-a:#0b1220; --bg-b:#111827; --bg-c:#1e1b4b;
      --card:rgba(15,23,42,.72); --ink:#e5e7eb; --muted:#9ca3af;
      --line:#334155; --pri:#3b82f6; --pri2:#2563eb;
      --ok:#22c55e; --err:#f87171; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at -10% -20%, var(--bg-c) 0%, transparent 60%),
        linear-gradient(145deg,var(--bg-a),var(--bg-b));
      min-height:100vh;
      transition: background .25s ease, color .25s ease;
    }

    .wrap{max-width:600px;margin:24px auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
    .back,.ghost{
      border:1px solid var(--line);background:var(--card);border-radius:10px;padding:8px 12px;
      color:var(--ink);text-decoration:none;font-weight:700;cursor:pointer
    }

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid color-mix(in srgb, var(--line) 60%, transparent);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    h1{margin:4px 0 6px;font-size:1.48rem;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:.92rem;line-height:1.45}

    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0 12px}
    .tab{border:1px solid var(--line);background:transparent;color:var(--ink);border-radius:12px;padding:11px;font-weight:800;cursor:pointer;transition:.15s}
    .tab.active{background:linear-gradient(180deg,var(--pri),var(--pri2));color:#fff;border-color:transparent;box-shadow:0 8px 18px color-mix(in srgb, var(--pri) 35%, transparent)}

    .panel{display:none}.panel.active{display:block}

    label{display:flex;justify-content:space-between;align-items:center;margin:11px 0 6px;font-size:.92rem;font-weight:700}
    .tiny{font-size:.75rem;color:var(--muted);font-weight:600}

    .input-wrap{position:relative}
    input{
      width:100%;padding:12px 42px 12px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:1rem;outline:none;background:transparent;color:var(--ink);transition:.15s
    }
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px color-mix(in srgb, #93c5fd 32%, transparent)}
    input.invalid{border-color:color-mix(in srgb, var(--err) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--err) 20%, transparent)}
    input.valid{border-color:color-mix(in srgb, var(--ok) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--ok) 20%, transparent)}

    .toggle-eye{
      position:absolute;right:9px;top:50%;transform:translateY(-50%);
      border:0;background:transparent;color:var(--muted);cursor:pointer;font-size:1rem
    }

    .inline{font-size:.82rem;margin-top:6px;min-height:1.2em;line-height:1.35}
    .inline.ok{color:var(--ok)} .inline.err{color:var(--err)} .inline.warn{color:var(--warn)}

    .cta{
      margin-top:13px;width:100%;border:0;border-radius:12px;padding:12px;
      color:#fff;background:linear-gradient(180deg,var(--pri),var(--pri2));font-weight:800;cursor:pointer;
      transition:.15s;box-shadow:0 8px 18px color-mix(in srgb, var(--pri) 36%, transparent)
    }
    .cta:disabled{opacity:.65;cursor:not-allowed}

    .msg{margin-top:12px;padding:10px 12px;border-radius:11px;font-size:.92rem;display:none}
    .msg.ok{display:block;background:color-mix(in srgb, var(--ok) 13%, transparent);color:var(--ok);border:1px solid color-mix(in srgb, var(--ok) 40%, transparent)}
    .msg.err{display:block;background:color-mix(in srgb, var(--err) 12%, transparent);color:var(--err);border:1px solid color-mix(in srgb, var(--err) 40%, transparent)}

    .token{margin-top:10px;padding:10px;border-radius:10px;background:#0f172a;color:#e2e8f0;font-family:ui-monospace,Menlo,monospace;font-size:.8rem;word-break:break-all;display:none}

    @media (max-width: 520px){
      .wrap{margin:12px auto}
      .card{padding:14px}
      h1{font-size:1.3rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="/" id="backBtn">‚Üê Back to Home</a>
      <button class="ghost" id="themeBtn">üåì Theme</button>
    </div>

    <div class="card">
      <h1 id="title">Account</h1>
      <div class="muted" id="subtitle">Create your account or login to continue learning across sessions.</div>

      <div class="tabs">
        <button id="tabRegister" class="tab active" onclick="switchTab('register')">Register</button>
        <button id="tabLogin" class="tab" onclick="switchTab('login')">Login</button>
      </div>

      <div id="panelRegister" class="panel active">
        <label for="rUser"><span id="labelUser">Username</span> <span class="tiny" id="ruleUser">min 5 chars</span></label>
        <div class="input-wrap"><input id="rUser" placeholder="At least 5 characters" autocomplete="username" /></div>
        <div id="rUserHint" class="inline"></div>

        <label for="rPass"><span id="labelPass">Password</span> <span class="tiny" id="rulePass">digits only, min 6</span></label>
        <div class="input-wrap">
          <input id="rPass" type="password" placeholder="At least 6 digits" autocomplete="new-password" />
          <button type="button" class="toggle-eye" onclick="togglePwd('rPass', this)">üëÅÔ∏è</button>
        </div>
        <div id="rPassHint" class="inline"></div>

        <label for="rPass2" id="labelPass2">Confirm Password</label>
        <div class="input-wrap">
          <input id="rPass2" type="password" placeholder="Re-enter your password" autocomplete="new-password" />
          <button type="button" class="toggle-eye" onclick="togglePwd('rPass2', this)">üëÅÔ∏è</button>
        </div>
        <div id="rPass2Hint" class="inline"></div>

        <button id="registerBtn" class="cta" onclick="register()">Create Account</button>
      </div>

      <div id="panelLogin" class="panel">
        <label for="lUser" id="lUserLabel">Username</label>
        <div class="input-wrap"><input id="lUser" placeholder="Your username" autocomplete="username" /></div>

        <label for="lPass" id="lPassLabel">Password</label>
        <div class="input-wrap">
          <input id="lPass" type="password" placeholder="Your password" autocomplete="current-password" />
          <button type="button" class="toggle-eye" onclick="togglePwd('lPass', this)">üëÅÔ∏è</button>
        </div>

        <button id="loginBtn" class="cta" onclick="login()">Login</button>
      </div>

      <div id="msg" class="msg"></div>
      <div id="token" class="token"></div>
    </div>
  </div>

  <script>
    const I18N = {
      en: {
        back:'‚Üê Back to Home', theme:'üåì Theme', title:'Account',
        subtitle:'Create your account or login to continue learning across sessions.',
        register:'Register', login:'Login',
        username:'Username', userRule:'min 5 chars',
        password:'Password', passRule:'digits only, min 6',
        confirm:'Confirm Password',
        phUser:'At least 5 characters', phPass:'At least 6 digits', phPass2:'Re-enter your password',
        loginUser:'Your username', loginPass:'Your password',
        create:'Create Account', creating:'Creating...',
        loginBtn:'Login', logging:'Logging in...',
        hUserOk:'Looks good.', hUserBad:'Username must be at least 5 characters.',
        hPassOk:'Password format is valid.', hPassBad:'Use digits only, at least 6 numbers.',
        hPass2Ok:'Passwords match.', hPass2Bad:'Passwords do not match yet.',
        fixFields:'Please fix the highlighted fields, then try again.',
        registerOk:'Account created. You are now logged in ‚Äî redirecting to home...',
        registerTaken:'This username is already taken. Try another one, or login directly.',
        registerFail:'Register failed. Please try again.',
        loginOk:(u)=>`Welcome back, ${u}! Redirecting...`,
        loginFail:'Login failed. Please check username/password and try again.',
        network:'Network issue. Please retry in a moment.',
        token:'Session token:'
      },
      zh: {
        back:'‚Üê ËøîÂõûÈ¶ñÈ°µ', theme:'üåì ‰∏ªÈ¢ò', title:'Ë¥¶Êà∑',
        subtitle:'ÂàõÂª∫Êñ∞Ë¥¶Âè∑ÊàñÁôªÂΩïÔºåÁªßÁª≠‰Ω†ÁöÑÂ≠¶‰π†ËøõÂ∫¶„ÄÇ',
        register:'Ê≥®ÂÜå', login:'ÁôªÂΩï',
        username:'Áî®Êà∑Âêç', userRule:'Ëá≥Â∞ë5‰∏™Â≠óÁ¨¶',
        password:'ÂØÜÁ†Å', passRule:'‰ªÖÊï∞Â≠óÔºåËá≥Â∞ë6‰Ωç',
        confirm:'Á°ÆËÆ§ÂØÜÁ†Å',
        phUser:'Ëá≥Â∞ë5‰∏™Â≠óÁ¨¶', phPass:'Ëá≥Â∞ë6‰ΩçÊï∞Â≠ó', phPass2:'ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å',
        loginUser:'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç', loginPass:'ËØ∑ËæìÂÖ•ÂØÜÁ†Å',
        create:'ÂàõÂª∫Ë¥¶Âè∑', creating:'ÂàõÂª∫‰∏≠...',
        loginBtn:'ÁôªÂΩï', logging:'ÁôªÂΩï‰∏≠...',
        hUserOk:'Áî®Êà∑ÂêçÂèØÁî®„ÄÇ', hUserBad:'Áî®Êà∑ÂêçËá≥Â∞ëÈúÄË¶Å5‰∏™Â≠óÁ¨¶„ÄÇ',
        hPassOk:'ÂØÜÁ†ÅÊ†ºÂºèÊ≠£Á°Æ„ÄÇ', hPassBad:'ÂØÜÁ†ÅÈúÄ‰∏∫Ëá≥Â∞ë6‰ΩçÊï∞Â≠ó„ÄÇ',
        hPass2Ok:'‰∏§Ê¨°ÂØÜÁ†Å‰∏ÄËá¥„ÄÇ', hPass2Bad:'‰∏§Ê¨°ÂØÜÁ†ÅÊöÇÊú™‰∏ÄËá¥„ÄÇ',
        fixFields:'ËØ∑ÂÖà‰øÆÊ≠£È´ò‰∫ÆÂ≠óÊÆµÂêéÂÜçÊèê‰∫§„ÄÇ',
        registerOk:'Ê≥®ÂÜåÊàêÂäüÔºåÂ∑≤Ëá™Âä®ÁôªÂΩïÔºåÊ≠£Âú®ËøîÂõûÈ¶ñÈ°µ...',
        registerTaken:'ËØ•Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºåÂª∫ËÆÆÊõ¥Êç¢ÊàñÁõ¥Êé•ÁôªÂΩï„ÄÇ',
        registerFail:'Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ',
        loginOk:(u)=>`Ê¨¢ËøéÂõûÊù•Ôºå${u}ÔºåÊ≠£Âú®ËøîÂõûÈ¶ñÈ°µ...`,
        loginFail:'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÊàñÂØÜÁ†Å„ÄÇ',
        network:'ÁΩëÁªúÂºÇÂ∏∏ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ',
        token:'‰ºöËØù‰ª§ÁâåÔºö'
      }
    };

    const state = {
      lang: (navigator.language || '').toLowerCase().startsWith('zh') ? 'zh' : 'en',
      t: null,
      theme: localStorage.getItem('vocabloop_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
    };

    const msg = document.getElementById('msg');
    const tokenBox = document.getElementById('token');
    const rUser = document.getElementById('rUser');
    const rPass = document.getElementById('rPass');
    const rPass2 = document.getElementById('rPass2');

    function applyTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('vocabloop_theme', theme);
    }

    function switchTheme(){ applyTheme(state.theme === 'dark' ? 'light' : 'dark'); }

    function applyI18n(){
      state.t = I18N[state.lang] || I18N.en;
      const t = state.t;
      document.documentElement.lang = state.lang === 'zh' ? 'zh-CN' : 'en';
      document.getElementById('backBtn').textContent = t.back;
      document.getElementById('themeBtn').textContent = t.theme;
      document.getElementById('title').textContent = t.title;
      document.getElementById('subtitle').textContent = t.subtitle;
      document.getElementById('tabRegister').textContent = t.register;
      document.getElementById('tabLogin').textContent = t.login;
      document.getElementById('labelUser').textContent = t.username;
      document.getElementById('ruleUser').textContent = t.userRule;
      document.getElementById('labelPass').textContent = t.password;
      document.getElementById('rulePass').textContent = t.passRule;
      document.getElementById('labelPass2').textContent = t.confirm;
      document.getElementById('lUserLabel').textContent = t.username;
      document.getElementById('lPassLabel').textContent = t.password;
      document.getElementById('registerBtn').textContent = t.create;
      document.getElementById('loginBtn').textContent = t.loginBtn;
      rUser.placeholder = t.phUser; rPass.placeholder = t.phPass; rPass2.placeholder = t.phPass2;
      document.getElementById('lUser').placeholder = t.loginUser;
      document.getElementById('lPass').placeholder = t.loginPass;
    }

    function switchTab(tab){
      const isRegister = tab === 'register';
      document.getElementById('tabRegister').classList.toggle('active', isRegister);
      document.getElementById('tabLogin').classList.toggle('active', !isRegister);
      document.getElementById('panelRegister').classList.toggle('active', isRegister);
      document.getElementById('panelLogin').classList.toggle('active', !isRegister);
      setMsg(''); setToken('');
    }

    function togglePwd(id, btn){
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    }

    function setMsg(text, type=''){
      msg.className = 'msg';
      msg.textContent = text || '';
      if(!text) return;
      msg.classList.add(type === 'ok' ? 'ok' : 'err');
    }

    function setToken(token){
      if(!token){ tokenBox.style.display='none'; tokenBox.textContent=''; return; }
      tokenBox.style.display='block';
      tokenBox.textContent = `${state.t.token}\n${token}`;
    }

    function saveAuth(user, token){
      if(!user || !user.username || !token) return;
      localStorage.setItem('vocabloop_auth', JSON.stringify({ username:user.username, token, at:Date.now() }));
    }

    function redirectHome(){ setTimeout(()=>{ window.location.href = '/'; }, 450); }

    function setInline(elId, text, type=''){
      const el = document.getElementById(elId);
      el.className = 'inline';
      el.textContent = text || '';
      if(type) el.classList.add(type);
    }

    function validateRegisterForm(){
      const t = state.t;
      const u = rUser.value.trim();
      const p = rPass.value.trim();
      const p2 = rPass2.value.trim();
      let ok = true;

      if(u.length >= 5){ setInline('rUserHint',t.hUserOk,'ok'); rUser.classList.add('valid'); rUser.classList.remove('invalid'); }
      else { ok = false; setInline('rUserHint',t.hUserBad,'warn'); rUser.classList.add('invalid'); rUser.classList.remove('valid'); }

      if(/^\d{6,}$/.test(p)){ setInline('rPassHint',t.hPassOk,'ok'); rPass.classList.add('valid'); rPass.classList.remove('invalid'); }
      else { ok = false; setInline('rPassHint',t.hPassBad,'warn'); rPass.classList.add('invalid'); rPass.classList.remove('valid'); }

      if(p2 && p === p2){ setInline('rPass2Hint',t.hPass2Ok,'ok'); rPass2.classList.add('valid'); rPass2.classList.remove('invalid'); }
      else { ok = false; setInline('rPass2Hint',t.hPass2Bad,'err'); rPass2.classList.add('invalid'); rPass2.classList.remove('valid'); }

      return ok;
    }

    async function callAuth(payload){
      const r = await fetch('/api/auth', {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)
      });
      return r.json();
    }

    async function register(){
      const t = state.t;
      if(!validateRegisterForm()){ setMsg(t.fixFields); return; }
      const btn = document.getElementById('registerBtn'); btn.disabled = true; btn.textContent = t.creating;
      try{
        const data = await callAuth({ action:'register', username:rUser.value.trim(), password:rPass.value.trim() });
        if(data.ok){ saveAuth(data.user, data.token); setMsg(t.registerOk,'ok'); setToken(data.token || ''); redirectHome(); }
        else {
          const m = (data.message || '').toLowerCase();
          if(m.includes('exists')) setMsg(t.registerTaken);
          else setMsg(data.message || t.registerFail);
          setToken('');
        }
      }catch(_){ setMsg(t.network); }
      finally { btn.disabled = false; btn.textContent = t.create; }
    }

    async function login(){
      const t = state.t;
      const btn = document.getElementById('loginBtn'); btn.disabled = true; btn.textContent = t.logging;
      try{
        const data = await callAuth({ action:'login', username:document.getElementById('lUser').value.trim(), password:document.getElementById('lPass').value.trim() });
        if(data.ok){ saveAuth(data.user, data.token); setMsg(t.loginOk(data.user?.username || 'user'),'ok'); setToken(data.token || ''); redirectHome(); }
        else { setMsg(t.loginFail); setToken(''); }
      }catch(_){ setMsg(t.network); }
      finally { btn.disabled = false; btn.textContent = t.loginBtn; }
    }

    [rUser, rPass, rPass2].forEach(el => el.addEventListener('input', validateRegisterForm));
    document.getElementById('themeBtn').addEventListener('click', switchTheme);

    applyTheme(state.theme);
    applyI18n();
    switchTab('register');
  </script>
</body>
</html>
