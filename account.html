<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VocabLoop Account</title>
  <style>
    :root{
      --bg-a:#dbeafe; --bg-b:#dcfce7; --bg-c:#ede9fe;
      --card:rgba(255,255,255,.88); --ink:#0f172a; --muted:#64748b;
      --line:#dbe2ea; --pri:#2563eb; --pri2:#1d4ed8;
      --ok:#16a34a; --err:#dc2626; --warn:#d97706;
      --shadow:0 14px 36px rgba(2,6,23,.12);
    }
    [data-theme="dark"]{
      --bg-a:#0b1220; --bg-b:#111827; --bg-c:#1e1b4b;
      --card:rgba(15,23,42,.72); --ink:#e5e7eb; --muted:#9ca3af;
      --line:#334155; --pri:#3b82f6; --pri2:#2563eb;
      --ok:#22c55e; --err:#f87171; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at -10% -20%, var(--bg-c) 0%, transparent 60%),
        linear-gradient(145deg,var(--bg-a),var(--bg-b));
      min-height:100vh;
      transition: background .25s ease, color .25s ease;
    }

    .wrap{max-width:600px;margin:24px auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
    .back,.ghost{
      border:1px solid var(--line);background:var(--card);border-radius:10px;padding:8px 12px;
      color:var(--ink);text-decoration:none;font-weight:700;cursor:pointer;
      transition: transform .12s, box-shadow .12s
    }
    .back:hover,.ghost:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .back:active,.ghost:active{transform:translateY(0);box-shadow:none}

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid color-mix(in srgb, var(--line) 60%, transparent);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    h1{margin:4px 0 6px;font-size:1.48rem;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:.92rem;line-height:1.45}

    /* â”€â”€ Tabs with sliding indicator â”€â”€ */
    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:0;margin:16px 0 12px;position:relative;
      background:color-mix(in srgb, var(--line) 35%, transparent);border-radius:14px;padding:3px}
    .tab{border:0;background:transparent;color:var(--muted);border-radius:11px;padding:11px;
      font-weight:800;cursor:pointer;transition: color .2s;position:relative;z-index:1}
    .tab.active{color:#fff}
    .tab-slider{position:absolute;top:3px;left:3px;width:calc(50% - 3px);height:calc(100% - 6px);
      background:linear-gradient(180deg,var(--pri),var(--pri2));border-radius:11px;
      transition:transform .28s cubic-bezier(.4,0,.2,1);
      box-shadow:0 4px 14px color-mix(in srgb, var(--pri) 35%, transparent);z-index:0}
    .tab-slider.right{transform:translateX(100%)}

    /* â”€â”€ Panel transitions â”€â”€ */
    .panels{position:relative;overflow:hidden}
    .panel{display:none;animation:panelIn .25s ease}
    .panel.active{display:block}
    @keyframes panelIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    label{display:flex;justify-content:space-between;align-items:center;margin:11px 0 6px;font-size:.92rem;font-weight:700}
    .tiny{font-size:.75rem;color:var(--muted);font-weight:600}

    .input-wrap{position:relative}
    input{
      width:100%;padding:12px 42px 12px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:1rem;outline:none;background:transparent;color:var(--ink);transition:.15s
    }
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px color-mix(in srgb, #93c5fd 32%, transparent)}
    input.invalid{border-color:color-mix(in srgb, var(--err) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--err) 20%, transparent)}
    input.valid{border-color:color-mix(in srgb, var(--ok) 60%, var(--line));box-shadow:0 0 0 3px color-mix(in srgb, var(--ok) 20%, transparent)}

    .toggle-eye{
      position:absolute;right:9px;top:50%;transform:translateY(-50%);
      border:0;background:transparent;color:var(--muted);cursor:pointer;font-size:1rem;
      transition:color .15s
    }
    .toggle-eye:hover{color:var(--ink)}

    /* â”€â”€ Password strength meter â”€â”€ */
    .strength-bar{height:4px;border-radius:2px;background:var(--line);margin-top:6px;overflow:hidden}
    .strength-fill{height:100%;width:0;border-radius:2px;transition:width .3s ease,background .3s ease}
    .strength-fill.s1{width:33%;background:var(--err)}
    .strength-fill.s2{width:66%;background:var(--warn)}
    .strength-fill.s3{width:100%;background:var(--ok)}

    .inline{font-size:.82rem;margin-top:6px;min-height:1.2em;line-height:1.35;
      transition:opacity .2s}
    .inline.ok{color:var(--ok)} .inline.err{color:var(--err)} .inline.warn{color:var(--warn)}

    /* â”€â”€ CTA buttons â”€â”€ */
    .cta{
      margin-top:16px;width:100%;border:0;border-radius:12px;padding:13px;
      color:#fff;background:linear-gradient(180deg,var(--pri),var(--pri2));font-weight:800;cursor:pointer;
      font-size:.95rem;letter-spacing:.3px;
      transition: transform .12s, box-shadow .15s, opacity .15s;
      box-shadow:0 8px 18px color-mix(in srgb, var(--pri) 36%, transparent);
      display:flex;align-items:center;justify-content:center;gap:8px
    }
    .cta:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 10px 24px color-mix(in srgb, var(--pri) 45%, transparent)}
    .cta:active:not(:disabled){transform:translateY(1px);box-shadow:0 4px 10px color-mix(in srgb, var(--pri) 25%, transparent)}
    .cta:disabled{opacity:.65;cursor:not-allowed}

    /* â”€â”€ Spinner â”€â”€ */
    .spinner{display:none;width:18px;height:18px;border:2.5px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    .cta.loading .spinner{display:block}
    .cta.loading .btn-text{opacity:.8}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ Message box â”€â”€ */
    .msg{margin-top:12px;padding:10px 12px;border-radius:11px;font-size:.92rem;
      display:none;align-items:center;gap:8px;animation:msgIn .25s ease}
    .msg.ok{display:flex;background:color-mix(in srgb, var(--ok) 13%, transparent);color:var(--ok);
      border:1px solid color-mix(in srgb, var(--ok) 40%, transparent)}
    .msg.err{display:flex;background:color-mix(in srgb, var(--err) 12%, transparent);color:var(--err);
      border:1px solid color-mix(in srgb, var(--err) 40%, transparent)}
    .msg-icon{font-size:1.1rem;flex-shrink:0}
    @keyframes msgIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

    /* â”€â”€ Shake on error â”€â”€ */
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .shake{animation:shake .4s ease}

    /* â”€â”€ Success overlay â”€â”€ */
    .success-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.35);backdrop-filter:blur(4px);z-index:100;opacity:0;
      transition:opacity .3s ease;pointer-events:none}
    .success-overlay.show{opacity:1;pointer-events:auto}
    .success-check{width:80px;height:80px;border-radius:50%;
      background:linear-gradient(135deg,var(--ok),#16a34a);
      display:flex;align-items:center;justify-content:center;
      transform:scale(0);transition:transform .35s cubic-bezier(.34,1.56,.64,1)}
    .success-overlay.show .success-check{transform:scale(1)}
    .success-check svg{width:44px;height:44px}
    .check-path{stroke-dasharray:50;stroke-dashoffset:50;animation:drawCheck .4s .3s ease forwards}
    @keyframes drawCheck{to{stroke-dashoffset:0}}

    /* â”€â”€ Offline mode panel (compact) â”€â”€ */
    .offline-panel{display:flex;align-items:center;gap:14px;padding:4px 0}
    .offline-icon{font-size:1.6rem;flex-shrink:0}
    .offline-body{flex:1;min-width:0}
    .offline-title{font-size:.95rem;font-weight:800;margin-bottom:2px}
    .offline-desc{color:var(--muted);font-size:.8rem;line-height:1.4}

    /* â”€â”€ Logged-in profile panel (compact horizontal) â”€â”€ */
    .profile{display:flex;align-items:center;gap:14px;padding:4px 0}
    .profile-avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;
      background:linear-gradient(135deg,var(--pri),#8b5cf6);
      display:flex;align-items:center;justify-content:center;
      font-size:1.2rem;color:#fff;font-weight:700}
    .profile-body{flex:1;min-width:0}
    .profile-name{font-size:1rem;font-weight:800;line-height:1.2}
    .profile-meta{color:var(--muted);font-size:.78rem}
    .btn-logout{border:1px solid var(--line);background:transparent;color:var(--err);border-radius:10px;
      padding:7px 14px;font-weight:700;cursor:pointer;transition:.15s;font-size:.82rem;flex-shrink:0}
    .btn-logout:hover{background:color-mix(in srgb, var(--err) 8%, transparent);border-color:var(--err)}

    /* â”€â”€ Bottom data management card â”€â”€ */
    .data-card{margin-top:16px}
    .data-card-title{margin:0 0 12px;font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:8px}
    .data-btns{display:flex;gap:10px}
    .btn-data{flex:1;border:1px solid var(--line);background:color-mix(in srgb, var(--line) 12%, transparent);
      color:var(--ink);border-radius:12px;
      padding:12px 14px;font-weight:700;cursor:pointer;transition:.15s;font-size:.88rem;
      display:flex;align-items:center;justify-content:center;gap:7px}
    .btn-data:hover{background:color-mix(in srgb, var(--pri) 8%, var(--card));border-color:var(--pri);
      transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .btn-data:active{transform:translateY(1px);box-shadow:none}
    .btn-data svg{width:16px;height:16px;flex-shrink:0}
    .data-hint{color:var(--muted);font-size:.75rem;margin-top:8px;line-height:1.4;text-align:center}

    /* â”€â”€ Toast â”€â”€ */
    .toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(80px);
      background:var(--ink);color:var(--card);padding:10px 20px;border-radius:12px;
      font-size:.88rem;font-weight:600;opacity:0;transition:all .3s ease;z-index:200;pointer-events:none;
      white-space:nowrap}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* â”€â”€ Learning Report â”€â”€ */
    .report-card{margin-top:16px;overflow:hidden}

    /* Entrance animations */
    @keyframes rptFadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
    @keyframes rptScaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
    @keyframes countUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes ringDraw{from{stroke-dashoffset:var(--ring-circumference)}to{stroke-dashoffset:var(--ring-offset)}}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes pulseGlow{0%,100%{box-shadow:0 0 0 0 rgba(37,99,235,.3)}50%{box-shadow:0 0 0 8px rgba(37,99,235,0)}}
    @keyframes floatBadge{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}

    .report-title{margin:0 0 20px;font-size:1.25rem;font-weight:800;display:flex;align-items:center;gap:10px;
      animation:rptFadeUp .5s ease both}
    .report-title-icon{font-size:1.5rem;display:inline-flex;animation:pulseGlow 2s ease-in-out infinite}

    /* â”€â”€ Metric cards grid â”€â”€ */
    .report-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:22px}
    .metric{text-align:center;padding:16px 10px 14px;border-radius:16px;position:relative;overflow:hidden;
      cursor:default;transition:transform .2s, box-shadow .2s;
      animation:rptScaleIn .45s ease both}
    .metric:nth-child(1){animation-delay:.05s}
    .metric:nth-child(2){animation-delay:.1s}
    .metric:nth-child(3){animation-delay:.15s}
    .metric:nth-child(4){animation-delay:.2s}
    .metric:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.1)}
    .metric::before{content:'';position:absolute;inset:0;opacity:.07;border-radius:16px;z-index:0}
    .metric.m-studied{background:linear-gradient(135deg,rgba(37,99,235,.1),rgba(96,165,250,.06));
      border:1px solid rgba(37,99,235,.2)}
    .metric.m-studied::before{background:linear-gradient(135deg,#2563eb,#60a5fa)}
    .metric.m-mastered{background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(167,139,250,.06));
      border:1px solid rgba(139,92,246,.2)}
    .metric.m-mastered::before{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}
    .metric.m-reviewed{background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.06));
      border:1px solid rgba(16,185,129,.2)}
    .metric.m-reviewed::before{background:linear-gradient(135deg,#10b981,#34d399)}
    .metric.m-streak{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(252,211,77,.06));
      border:1px solid rgba(245,158,11,.2)}
    .metric.m-streak::before{background:linear-gradient(135deg,#f59e0b,#fcd34d)}
    .metric-icon{font-size:1.3rem;margin-bottom:4px;position:relative;z-index:1}
    .metric-val{font-size:1.7rem;font-weight:900;line-height:1.2;position:relative;z-index:1;
      animation:countUp .5s ease both}
    .metric.m-studied .metric-val{color:#2563eb}
    .metric.m-mastered .metric-val{color:#8b5cf6}
    .metric.m-reviewed .metric-val{color:#10b981}
    .metric.m-streak .metric-val{color:#f59e0b}
    [data-theme="dark"] .metric.m-studied .metric-val{color:#60a5fa}
    [data-theme="dark"] .metric.m-mastered .metric-val{color:#a78bfa}
    [data-theme="dark"] .metric.m-reviewed .metric-val{color:#34d399}
    [data-theme="dark"] .metric.m-streak .metric-val{color:#fcd34d}
    .metric-label{font-size:.76rem;color:var(--muted);font-weight:600;margin-top:3px;position:relative;z-index:1}

    /* â”€â”€ Collapsible sections â”€â”€ */
    .report-section{margin-bottom:16px;animation:rptFadeUp .5s ease both}
    .report-section:nth-of-type(2){animation-delay:.2s}
    .report-section:nth-of-type(3){animation-delay:.3s}
    .report-section:nth-of-type(4){animation-delay:.4s}
    .report-section:nth-of-type(5){animation-delay:.5s}
    .section-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;
      padding:10px 12px;margin:-2px -4px 10px;border-radius:12px;transition:background .15s;user-select:none}
    .section-header:hover{background:color-mix(in srgb, var(--pri) 6%, transparent)}
    .section-header:active{background:color-mix(in srgb, var(--pri) 10%, transparent)}
    .section-header h3{margin:0;font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:6px}
    .section-toggle{width:20px;height:20px;transition:transform .25s ease;color:var(--muted);flex-shrink:0}
    .section-toggle.collapsed{transform:rotate(-90deg)}
    .section-body{overflow:hidden;transition:max-height .35s cubic-bezier(.4,0,.2,1),opacity .25s ease;
      max-height:800px;opacity:1}
    .section-body.collapsed{max-height:0;opacity:0}

    /* â”€â”€ Deck progress bars â”€â”€ */
    .deck-row{margin-bottom:12px;padding:10px 12px;border-radius:12px;
      background:color-mix(in srgb, var(--line) 20%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 40%, transparent);
      transition:transform .15s, box-shadow .15s;cursor:default}
    .deck-row:hover{transform:translateX(3px);box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .deck-row-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .deck-name{font-size:.9rem;font-weight:700;display:flex;align-items:center;gap:6px}
    .deck-name-badge{font-size:.65rem;font-weight:700;padding:2px 7px;border-radius:6px;
      background:linear-gradient(135deg,var(--pri),#60a5fa);color:#fff}
    .deck-nums{font-size:.78rem;color:var(--muted);font-weight:500}
    .bar-bg{height:10px;border-radius:5px;background:var(--line);overflow:hidden;position:relative}
    .bar-fill{height:100%;border-radius:5px;position:absolute;top:0;left:0;
      transition:width .8s cubic-bezier(.25,.46,.45,.94);min-width:0}
    .bar-fill.fill-studied{background:linear-gradient(90deg,#2563eb,#60a5fa);z-index:1}
    .bar-fill.fill-mastered{background:linear-gradient(90deg,#8b5cf6,#c4b5fd);z-index:2}
    .deck-legend{display:flex;gap:14px;margin-top:6px}
    .deck-legend-item{display:flex;align-items:center;gap:4px;font-size:.7rem;color:var(--muted)}
    .deck-legend-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

    /* â”€â”€ Ring chart for stage distribution â”€â”€ */
    .stage-chart-wrap{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
    .ring-chart{position:relative;width:120px;height:120px;flex-shrink:0;margin:0 auto 8px}
    .ring-chart svg{transform:rotate(-90deg);width:120px;height:120px}
    .ring-chart circle{fill:none;stroke-width:12;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1)}
    .ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
      justify-content:center;text-align:center}
    .ring-center-val{font-size:1.4rem;font-weight:900;color:var(--ink);line-height:1}
    .ring-center-label{font-size:.65rem;color:var(--muted);font-weight:600;margin-top:2px}
    .stage-legend{flex:1;min-width:140px}
    .stage-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:6px 10px;
      border-radius:10px;transition:background .15s;cursor:default}
    .stage-row:hover{background:color-mix(in srgb, var(--line) 30%, transparent)}
    .stage-dot{width:12px;height:12px;border-radius:4px;flex-shrink:0;transition:transform .15s}
    .stage-row:hover .stage-dot{transform:scale(1.25)}
    .stage-name{font-size:.85rem;font-weight:600;flex:1}
    .stage-count{font-size:.82rem;font-weight:700;color:var(--ink)}
    .stage-pct{font-size:.7rem;color:var(--muted);font-weight:500;margin-left:2px}

    /* â”€â”€ Difficult words list â”€â”€ */
    .diff-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;
      margin-bottom:8px;transition:transform .15s, box-shadow .15s;cursor:default;position:relative;overflow:hidden}
    .diff-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:2px}
    .diff-item:hover{transform:translateX(4px);box-shadow:0 3px 14px rgba(0,0,0,.08)}
    .diff-item.severity-high{background:color-mix(in srgb, var(--err) 8%, transparent);
      border:1px solid color-mix(in srgb, var(--err) 18%, transparent)}
    .diff-item.severity-high::before{background:var(--err)}
    .diff-item.severity-med{background:color-mix(in srgb, var(--warn) 8%, transparent);
      border:1px solid color-mix(in srgb, var(--warn) 18%, transparent)}
    .diff-item.severity-med::before{background:var(--warn)}
    .diff-item.severity-low{background:color-mix(in srgb, var(--pri) 6%, transparent);
      border:1px solid color-mix(in srgb, var(--pri) 15%, transparent)}
    .diff-item.severity-low::before{background:var(--pri)}
    .diff-rank{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      font-size:.7rem;font-weight:800;color:#fff;flex-shrink:0}
    .severity-high .diff-rank{background:var(--err)}
    .severity-med .diff-rank{background:var(--warn)}
    .severity-low .diff-rank{background:var(--pri)}
    .diff-word{font-weight:800;font-size:.95rem;min-width:80px}
    .diff-zh{color:var(--muted);font-size:.82rem;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .diff-badge{font-size:.72rem;font-weight:700;white-space:nowrap;padding:3px 8px;border-radius:6px}
    .severity-high .diff-badge{background:color-mix(in srgb, var(--err) 12%, transparent);color:var(--err)}
    .severity-med .diff-badge{background:color-mix(in srgb, var(--warn) 12%, transparent);color:var(--warn)}
    .severity-low .diff-badge{background:color-mix(in srgb, var(--pri) 10%, transparent);color:var(--pri)}

    /* â”€â”€ Achievement pills â”€â”€ */
    .achieve-grid{display:flex;flex-wrap:wrap;gap:10px}
    .achieve-pill{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:24px;
      font-size:.82rem;font-weight:600;cursor:default;transition:transform .15s, box-shadow .15s;
      background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(52,211,153,.04));
      border:1px solid color-mix(in srgb, var(--ok) 22%, transparent);color:var(--ok);
      animation:rptScaleIn .4s ease both}
    .achieve-pill:hover{transform:translateY(-2px) scale(1.04);
      box-shadow:0 4px 16px color-mix(in srgb, var(--ok) 20%, transparent)}
    .achieve-pill .achieve-emoji{font-size:1.1rem;animation:floatBadge 2s ease-in-out infinite}

    /* â”€â”€ Empty state â”€â”€ */
    .report-empty{text-align:center;padding:36px 16px;color:var(--muted);font-size:.95rem;
      animation:rptFadeUp .5s ease both}
    .report-empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:.6}
    .report-empty-text{line-height:1.5}

    /* â”€â”€ Overall progress ring at top â”€â”€ */
    .overall-progress{display:flex;align-items:center;justify-content:center;gap:16px;
      margin-bottom:20px;padding:14px;border-radius:14px;
      background:linear-gradient(135deg,color-mix(in srgb, var(--pri) 5%, transparent),
        color-mix(in srgb, #8b5cf6 4%, transparent));
      border:1px solid color-mix(in srgb, var(--pri) 12%, transparent);
      animation:rptFadeUp .4s ease both}
    .overall-ring{position:relative;width:64px;height:64px;flex-shrink:0}
    .overall-ring svg{transform:rotate(-90deg);width:64px;height:64px}
    .overall-ring circle{fill:none;stroke-width:6}
    .overall-ring-val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-size:.95rem;font-weight:900;color:var(--pri)}
    .overall-info{flex:1}
    .overall-info-title{font-size:.82rem;font-weight:700;color:var(--ink);margin-bottom:2px}
    .overall-info-sub{font-size:.75rem;color:var(--muted);line-height:1.4}

    /* â”€â”€ AI Insight section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ai-insight-section{margin-top:16px;border-radius:16px;overflow:hidden;
      border:1.5px solid color-mix(in srgb, var(--pri) 28%, var(--line));
      animation:rptFadeUp .5s .45s ease both}
    .ai-insight-header{display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;
      background:linear-gradient(135deg,color-mix(in srgb, var(--pri) 7%,transparent),
        color-mix(in srgb,#8b5cf6 5%,transparent))}
    .ai-insight-title{font-size:.9rem;font-weight:800;color:var(--pri);display:flex;align-items:center;gap:6px}
    .ai-insight-btn{border:1.5px solid var(--pri);background:var(--pri);color:#fff;border-radius:99px;
      padding:7px 16px;font-size:.8rem;font-weight:700;cursor:pointer;transition:opacity .15s,transform .1s;
      white-space:nowrap}
    .ai-insight-btn:hover{opacity:.85;transform:scale(1.03)}
    .ai-insight-btn:active{transform:scale(.96)}
    .ai-insight-btn:disabled{opacity:.5;cursor:default;transform:none}
    .ai-insight-body{padding:0 16px 16px}
    .ai-insight-loading{display:flex;align-items:center;gap:8px;font-size:.84rem;color:var(--muted);padding:12px 0}
    .ai-insight-spinner{width:16px;height:16px;border:2px solid var(--line);border-top-color:var(--pri);
      border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0}
    .ai-insight-summary{font-size:.88rem;line-height:1.7;color:var(--ink);margin:12px 0 14px;
      padding:12px 14px;border-radius:12px;
      background:color-mix(in srgb, var(--pri) 5%, transparent);
      border-left:3px solid color-mix(in srgb, var(--pri) 60%, transparent)}
    .ai-insight-suggest-title{font-size:.72rem;font-weight:800;letter-spacing:.06em;text-transform:uppercase;
      color:var(--muted);margin-bottom:8px}
    .ai-insight-suggest-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    .ai-insight-suggest-list li{display:flex;align-items:flex-start;gap:8px;font-size:.86rem;
      line-height:1.55;color:var(--ink)}
    .ai-insight-suggest-list li::before{content:'â†’';color:var(--pri);font-weight:800;flex-shrink:0;margin-top:1px}
    .ai-insight-err{color:var(--err);font-size:.83rem;padding:10px 0}
    .ai-insight-status{font-size:.74rem;color:var(--muted);padding:2px 16px 8px;line-height:1.4}

    /* â”€â”€ Share progress banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .share-progress{margin-top:20px;padding-top:18px;border-top:1px solid var(--line);
      display:flex;flex-direction:column;align-items:center;gap:14px;
      animation:rptFadeUp .5s .25s ease both}
    .share-preview{width:100%;border-radius:14px;padding:14px 16px;
      background:linear-gradient(135deg,color-mix(in srgb,var(--pri) 7%,var(--card)),
        color-mix(in srgb,#8b5cf6 7%,var(--card)));
      border:1px solid color-mix(in srgb,var(--pri) 18%,var(--line));
      font-size:.82rem;line-height:1.85;color:var(--ink);white-space:pre-wrap;word-break:break-word}
    .share-preview-label{font-size:.7rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
      color:var(--muted);margin-bottom:6px}
    .share-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
    .share-main-btn{display:flex;align-items:center;gap:8px;
      background:linear-gradient(135deg,var(--pri),#8b5cf6);color:#fff;border:none;
      border-radius:99px;padding:11px 26px;font-size:.88rem;font-weight:700;cursor:pointer;
      transition:opacity .15s,transform .1s,box-shadow .15s;
      box-shadow:0 4px 18px color-mix(in srgb,var(--pri) 32%,transparent)}
    .share-main-btn:hover{opacity:.9;transform:scale(1.03)}
    .share-main-btn:active{transform:scale(.96)}
    .share-main-btn.copied{background:linear-gradient(135deg,var(--ok),#34d399);
      box-shadow:0 4px 18px color-mix(in srgb,var(--ok) 32%,transparent)}
    .share-hint{font-size:.75rem;color:var(--muted);text-align:center}

    @media (max-width: 520px){
      .wrap{margin:12px auto}
      .card{padding:14px}
      h1{font-size:1.3rem}
      .report-metrics{grid-template-columns:repeat(2,1fr);gap:10px}
      .ring-chart{width:100px;height:100px}
      .ring-chart svg{width:100px;height:100px}
      .stage-chart-wrap{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="./" id="backBtn">â† Back to Home</a>
      <button class="ghost" id="themeBtn">ğŸŒ“ Theme</button>
    </div>

    <!-- â‘  Account section (compact) -->
    <div class="card" id="accountCard">
      <!-- Logged-in profile (compact horizontal) -->
      <div id="profilePanel" class="profile" style="display:none">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-body">
          <div class="profile-name" id="profileName">username</div>
          <div class="profile-meta" id="profileMeta">Logged in</div>
        </div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>

      <!-- Offline mode (compact) -->
      <div id="offlinePanel" style="display:none">
        <div class="offline-panel">
          <div class="offline-icon">ğŸ’¾</div>
          <div class="offline-body">
            <div class="offline-title" id="offlineTitle">Local Mode</div>
            <div class="offline-desc" id="offlineDesc">Your progress is saved in this browser. Register to sync across devices.</div>
          </div>
        </div>
      </div>

      <!-- Auth form view -->
      <div id="authPanel" style="display:none">
        <h1 id="title">Account</h1>
        <div class="muted" id="subtitle">Create your account or login to continue learning across sessions.</div>

        <div class="tabs">
          <button id="tabRegister" class="tab active">Register</button>
          <button id="tabLogin" class="tab">Login</button>
          <div class="tab-slider" id="tabSlider"></div>
        </div>

        <div class="panels">
          <div id="panelRegister" class="panel active">
            <form id="registerForm" autocomplete="on" novalidate>
              <label for="rUser"><span id="labelUser">Username</span> <span class="tiny" id="ruleUser">min 5 chars</span></label>
              <div class="input-wrap"><input id="rUser" placeholder="At least 5 characters" autocomplete="username" /></div>
              <div id="rUserHint" class="inline"></div>

              <label for="rPass"><span id="labelPass">Password</span> <span class="tiny" id="rulePass">digits only, min 6</span></label>
              <div class="input-wrap">
                <input id="rPass" type="password" inputmode="numeric" placeholder="At least 6 digits" autocomplete="new-password" />
                <button type="button" class="toggle-eye" data-target="rPass">ğŸ‘ï¸</button>
              </div>
              <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
              <div id="rPassHint" class="inline"></div>

              <label for="rPass2" id="labelPass2">Confirm Password</label>
              <div class="input-wrap">
                <input id="rPass2" type="password" inputmode="numeric" placeholder="Re-enter your password" autocomplete="new-password" />
                <button type="button" class="toggle-eye" data-target="rPass2">ğŸ‘ï¸</button>
              </div>
              <div id="rPass2Hint" class="inline"></div>

              <button type="submit" id="registerBtn" class="cta">
                <span class="btn-text">Create Account</span>
                <span class="spinner"></span>
              </button>
            </form>
          </div>

          <div id="panelLogin" class="panel">
            <form id="loginForm" autocomplete="on" novalidate>
              <label for="lUser" id="lUserLabel">Username</label>
              <div class="input-wrap"><input id="lUser" placeholder="Your username" autocomplete="username" /></div>

              <label for="lPass" id="lPassLabel">Password</label>
              <div class="input-wrap">
                <input id="lPass" type="password" inputmode="numeric" placeholder="Your password" autocomplete="current-password" />
                <button type="button" class="toggle-eye" data-target="lPass">ğŸ‘ï¸</button>
              </div>

              <button type="submit" id="loginBtn" class="cta">
                <span class="btn-text">Login</span>
                <span class="spinner"></span>
              </button>
            </form>
          </div>
        </div>

        <div id="msg" class="msg"><span class="msg-icon"></span><span class="msg-text"></span></div>
      </div>
    </div>

    <!-- Learning Report Card -->
    <div class="card report-card" id="reportCard" style="display:none">
      <div class="report-title"><span class="report-title-icon">ğŸ“Š</span> <span id="reportTitle">å­¦ä¹ æŠ¥å‘Š</span></div>

      <!-- Overall mastery ring -->
      <div class="overall-progress" id="overallProgress" style="display:none">
        <div class="overall-ring">
          <svg viewBox="0 0 64 64">
            <circle cx="32" cy="32" r="28" stroke="var(--line)" stroke-width="6"/>
            <circle id="overallRingFill" cx="32" cy="32" r="28" stroke="var(--pri)" stroke-width="6"
              stroke-linecap="round" stroke-dasharray="175.93" stroke-dashoffset="175.93"
              style="transition:stroke-dashoffset 1s cubic-bezier(.4,0,.2,1)"/>
          </svg>
          <div class="overall-ring-val" id="overallPct">0%</div>
        </div>
        <div class="overall-info">
          <div class="overall-info-title" id="overallTitle">æ€»ä½“è¿›åº¦</div>
          <div class="overall-info-sub" id="overallSub"></div>
        </div>
      </div>

      <!-- Key metrics -->
      <div class="report-metrics" id="reportMetrics">
        <div class="metric m-studied">
          <div class="metric-icon">ğŸ“š</div>
          <div class="metric-val" id="rStudied">0</div>
          <div class="metric-label" id="rStudiedL">å·²å­¦</div>
        </div>
        <div class="metric m-mastered">
          <div class="metric-icon">ğŸ‘‘</div>
          <div class="metric-val" id="rMastered">0</div>
          <div class="metric-label" id="rMasteredL">å·²æŒæ¡</div>
        </div>
        <div class="metric m-reviewed">
          <div class="metric-icon">ğŸ”„</div>
          <div class="metric-val" id="rReviewed">0</div>
          <div class="metric-label" id="rReviewedL">æ€»å¤ä¹ </div>
        </div>
        <div class="metric m-streak">
          <div class="metric-icon">ğŸ”¥</div>
          <div class="metric-val" id="rStreak">0</div>
          <div class="metric-label" id="rStreakL">è¿ç»­å¤©</div>
        </div>
      </div>

      <!-- Deck progress -->
      <div class="report-section" id="deckSection">
        <div class="section-header" onclick="toggleSection('deckBody','deckToggle')">
          <h3 id="rDeckTitle">è¯åº“è¿›åº¦</h3>
          <svg class="section-toggle" id="deckToggle" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/>
          </svg>
        </div>
        <div class="section-body" id="deckBody">
          <div id="deckBars"></div>
        </div>
      </div>

      <!-- Stage distribution -->
      <div class="report-section" id="stageSection">
        <div class="section-header" onclick="toggleSection('stageBody','stageToggle')">
          <h3 id="rStageTitle">é˜¶æ®µåˆ†å¸ƒ</h3>
          <svg class="section-toggle" id="stageToggle" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/>
          </svg>
        </div>
        <div class="section-body" id="stageBody">
          <div class="stage-chart-wrap" id="stageChartWrap"></div>
        </div>
      </div>

      <!-- Difficult words -->
      <div class="report-section" id="difficultSection" style="display:none">
        <div class="section-header" onclick="toggleSection('diffBody','diffToggle')">
          <h3 id="rDiffTitle">âš ï¸ å›°éš¾è¯ TOP 10</h3>
          <svg class="section-toggle" id="diffToggle" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/>
          </svg>
        </div>
        <div class="section-body" id="diffBody">
          <div id="difficultList"></div>
        </div>
      </div>

      <!-- Achievements -->
      <div class="report-section" id="achieveSection" style="display:none">
        <div class="section-header" onclick="toggleSection('achieveBody','achieveToggle')">
          <h3 id="rAchieveTitle">ğŸ† æˆå°±</h3>
          <svg class="section-toggle" id="achieveToggle" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/>
          </svg>
        </div>
        <div class="section-body" id="achieveBody">
          <div class="achieve-grid" id="achieveList"></div>
        </div>
      </div>

      <!-- AI Learning Insights -->
      <div class="ai-insight-section" id="aiInsightSection" style="display:none">
        <div class="ai-insight-header">
          <div class="ai-insight-title">âœ¨ <span id="aiInsightTitle">AI å­¦ä¹ æ´å¯Ÿ</span></div>
          <button class="ai-insight-btn" id="aiInsightBtn" onclick="generateInsight()">
            <span id="aiInsightBtnLabel">ç”Ÿæˆå»ºè®®</span>
          </button>
        </div>
        <div class="ai-insight-status" id="aiInsightStatus" style="display:none"></div>
        <div class="ai-insight-body" id="aiInsightBody" style="display:none">
          <div class="ai-insight-loading" id="aiInsightLoading" style="display:none">
            <div class="ai-insight-spinner"></div>
            <span id="aiInsightLoadingText">AI åˆ†æä¸­â€¦</span>
          </div>
          <div id="aiInsightResult" style="display:none">
            <div class="ai-insight-summary" id="aiInsightSummary"></div>
            <div class="ai-insight-suggest-title" id="aiInsightSuggestTitle">å­¦ä¹ å»ºè®®</div>
            <ul class="ai-insight-suggest-list" id="aiInsightSuggestions"></ul>
          </div>
          <div class="ai-insight-err" id="aiInsightErr" style="display:none"></div>
        </div>
      </div>

      <!-- Share progress banner -->
      <div class="share-progress" id="shareProgress" style="display:none">
        <div style="width:100%">
          <div class="share-preview-label" id="sharePreviewLabel">åˆ†äº«é¢„è§ˆ</div>
          <div class="share-preview" id="sharePreviewText"></div>
        </div>
        <div class="share-actions">
          <button class="share-main-btn" id="shareMainBtn" onclick="doShareProgress()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
            <span id="shareBtnLabel">åˆ†äº«å­¦ä¹ è¿›åº¦</span>
          </button>
        </div>
        <div class="share-hint" id="shareHintText">è®©æœ‹å‹è§è¯ä½ çš„æˆé•¿ âœ¨</div>
      </div>
    </div>

    <!-- â‘¢ Data Management card (always visible at bottom) -->
    <div class="card data-card" id="dataCard">
      <div class="data-card-title" id="dataCardTitle">ğŸ’¾ <span id="dataTitle">Data Management</span></div>
      <div class="data-btns">
        <button class="btn-data" onclick="exportProgress()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          <span id="exportLabel">Export</span>
        </button>
        <button class="btn-data" onclick="document.getElementById('importFileInput').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <span id="importLabel">Import</span>
        </button>
      </div>
      <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
      <div class="data-hint" id="dataHint">Export your learning progress as JSON backup, or import from a previous backup file.</div>
    </div>
  </div>

  <!-- Success overlay -->
  <div class="success-overlay" id="successOverlay">
    <div class="success-check">
      <svg viewBox="0 0 44 44" fill="none">
        <path class="check-path" d="M10 22 L19 31 L34 14" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const I18N = {
      en: {
        back:'â† Back to Home', theme:'ğŸŒ“ Theme', title:'Account',
        subtitle:'Create your account or login to continue learning across sessions.',
        register:'Register', login:'Login',
        username:'Username', userRule:'min 5 chars',
        password:'Password', passRule:'digits only, min 6',
        confirm:'Confirm Password',
        phUser:'At least 5 characters', phPass:'At least 6 digits', phPass2:'Re-enter your password',
        loginUser:'Your username', loginPass:'Your password',
        create:'Create Account', creating:'Creating...',
        loginBtn:'Login', logging:'Logging in...',
        hUserOk:'Looks good.', hUserBad:'Username must be at least 5 characters.',
        hPassOk:'Password format is valid.', hPassBad:'Use digits only, at least 6 numbers.',
        hPass2Ok:'Passwords match.', hPass2Bad:'Passwords do not match yet.',
        fixFields:'Please fix the highlighted fields, then try again.',
        registerOk:'Account created. You are now logged in!',
        registerTaken:'This username is already taken. Try another one, or login directly.',
        registerFail:'Register failed. Please try again.',
        loginOk:(u)=>`Welcome back, ${u}!`,
        loginFail:'Login failed. Please check username/password and try again.',
        network:'Network issue. Please retry in a moment.',
        loggedIn:'Logged in',
        logout:'Logout',
        logoutConfirm:'Are you sure you want to logout?',
        strengthWeak:'Weak', strengthMedium:'Medium', strengthStrong:'Strong',
        exportBtn:'Export', importBtn:'Import',
        importConfirm:'Import learning records from file.\nExisting words will be smart-merged (keeping the more recently reviewed version). No data will be lost.\n\nProceed?',
        importOk:(n)=>`Imported! Merged data from ${n} deck${n===1?'':'s'}`,
        importFail:'Import failed: invalid file format',
        importEmpty:'No learning records found in file',
        exportOk:'Export âœ“',
        dataTitle:'Data Management',
        dataHint:'Export your learning progress as JSON backup, or import from a previous backup file.',
        offlineTitle:'Local Mode',
        offlineDesc:'Your progress is saved in this browser. Register to sync across devices.',
        /* Report */
        rptTitle:'ğŸ“Š Learning Report', rptStudied:'Studied', rptMastered:'Mastered',
        rptReviewed:'Reviews', rptStreak:'Streak', rptDeckTitle:'Deck Progress',
        rptStageTitle:'Stage Distribution', rptDiffTitle:'âš ï¸ Difficult Words TOP 10',
        rptAchieveTitle:'ğŸ† Achievements', rptEmpty:'Start learning to see your report!',
        rptNew:'New', rptLearning:'Learning', rptReview:'Review', rptMasteredStage:'Mastered',
        rptAgain:(n)=>`Again Ã—${n}`,
        rptStudiedOf:(a,b)=>`${a} studied / ${b} mastered`,
        rptOverall:'Overall Progress',
        rptOverallSub:(studied,total,masteredPct)=>`${studied} / ${total} words studied, ${masteredPct}% mastered`,
        sharePreviewLabel:'Share Preview',
        shareBtnLabel:'Share Progress',
        shareHint:'Show your progress to friends âœ¨',
        shareCopied:'Copied âœ“',
        shareCopyFallback:'Copy to share:',
        /* AI Insight */
        aiInsightTitle:'AI Learning Insights',
        aiInsightBtn:'Generate Insights',
        aiInsightBtnRegen:'Regenerate',
        aiInsightLoading:'Analyzing your progressâ€¦',
        aiInsightSuggestTitle:'Study Tips',
        aiInsightErr:'Failed to generate insights. Please try again.',
        aiInsightNoChange:'No new progress',
        aiInsightCooldown:(h,m)=>h>0?`Update in ${h}h ${m}m`:`Update in ${m}m`,
        aiInsightLastGen:(s)=>`Generated: ${s}`,
        aiInsightRetry:'Retry',
      },
      zh: {
        back:'â† è¿”å›é¦–é¡µ', theme:'ğŸŒ“ ä¸»é¢˜', title:'è´¦æˆ·',
        subtitle:'åˆ›å»ºæ–°è´¦å·æˆ–ç™»å½•ï¼Œç»§ç»­ä½ çš„å­¦ä¹ è¿›åº¦ã€‚',
        register:'æ³¨å†Œ', login:'ç™»å½•',
        username:'ç”¨æˆ·å', userRule:'è‡³å°‘5ä¸ªå­—ç¬¦',
        password:'å¯†ç ', passRule:'ä»…æ•°å­—ï¼Œè‡³å°‘6ä½',
        confirm:'ç¡®è®¤å¯†ç ',
        phUser:'è‡³å°‘5ä¸ªå­—ç¬¦', phPass:'è‡³å°‘6ä½æ•°å­—', phPass2:'å†æ¬¡è¾“å…¥å¯†ç ',
        loginUser:'è¯·è¾“å…¥ç”¨æˆ·å', loginPass:'è¯·è¾“å…¥å¯†ç ',
        create:'åˆ›å»ºè´¦å·', creating:'åˆ›å»ºä¸­...',
        loginBtn:'ç™»å½•', logging:'ç™»å½•ä¸­...',
        hUserOk:'ç”¨æˆ·åå¯ç”¨ã€‚', hUserBad:'ç”¨æˆ·åè‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦ã€‚',
        hPassOk:'å¯†ç æ ¼å¼æ­£ç¡®ã€‚', hPassBad:'å¯†ç éœ€ä¸ºè‡³å°‘6ä½æ•°å­—ã€‚',
        hPass2Ok:'ä¸¤æ¬¡å¯†ç ä¸€è‡´ã€‚', hPass2Bad:'ä¸¤æ¬¡å¯†ç æš‚æœªä¸€è‡´ã€‚',
        fixFields:'è¯·å…ˆä¿®æ­£é«˜äº®å­—æ®µåå†æäº¤ã€‚',
        registerOk:'æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•ï¼',
        registerTaken:'è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œå»ºè®®æ›´æ¢æˆ–ç›´æ¥ç™»å½•ã€‚',
        registerFail:'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚',
        loginOk:(u)=>`æ¬¢è¿å›æ¥ï¼Œ${u}ï¼`,
        loginFail:'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæˆ–å¯†ç ã€‚',
        network:'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚',
        loggedIn:'å·²ç™»å½•',
        logout:'é€€å‡ºç™»å½•',
        logoutConfirm:'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
        strengthWeak:'å¼±', strengthMedium:'ä¸­', strengthStrong:'å¼º',
        exportBtn:'å¯¼å‡º', importBtn:'å¯¼å…¥',
        importConfirm:'å°†ä»æ–‡ä»¶ä¸­å¯¼å…¥å­¦ä¹ è®°å½•ã€‚\nå·²æœ‰çš„å•è¯å°†æ™ºèƒ½åˆå¹¶ï¼ˆä¿ç•™å¤ä¹ æ›´è¿‘çš„ç‰ˆæœ¬ï¼‰ï¼Œä¸ä¼šä¸¢å¤±ç°æœ‰è¿›åº¦ã€‚\n\nç¡®å®šå¯¼å…¥å—ï¼Ÿ',
        importOk:(n)=>`å¯¼å…¥æˆåŠŸï¼å·²åˆå¹¶ ${n} ä¸ªè¯åº“çš„æ•°æ®`,
        importFail:'å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®',
        importEmpty:'æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å­¦ä¹ è®°å½•',
        exportOk:'å¯¼å‡º âœ“',
        dataTitle:'æ•°æ®ç®¡ç†',
        dataHint:'å¯¼å‡ºå­¦ä¹ è¿›åº¦ä¸º JSON å¤‡ä»½ï¼Œæˆ–ä»å¤‡ä»½æ–‡ä»¶ä¸­å¯¼å…¥ã€‚',
        offlineTitle:'æœ¬åœ°æ¨¡å¼',
        offlineDesc:'å­¦ä¹ è¿›åº¦ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚æ³¨å†Œè´¦æˆ·åå¯è·¨è®¾å¤‡åŒæ­¥ã€‚',
        /* Report */
        rptTitle:'ğŸ“Š å­¦ä¹ æŠ¥å‘Š', rptStudied:'å·²å­¦', rptMastered:'å·²æŒæ¡',
        rptReviewed:'æ€»å¤ä¹ ', rptStreak:'è¿ç»­å¤©', rptDeckTitle:'è¯åº“è¿›åº¦',
        rptStageTitle:'é˜¶æ®µåˆ†å¸ƒ', rptDiffTitle:'âš ï¸ å›°éš¾è¯ TOP 10',
        rptAchieveTitle:'ğŸ† æˆå°±', rptEmpty:'å¼€å§‹å­¦ä¹ åå³å¯æŸ¥çœ‹æŠ¥å‘Šï¼',
        rptNew:'æœªå­¦', rptLearning:'å­¦ä¹ ä¸­', rptReview:'å¤ä¹ ä¸­', rptMasteredStage:'å·²æŒæ¡',
        rptAgain:(n)=>`å¿˜è®° Ã—${n}`,
        rptStudiedOf:(a,b)=>`å·²å­¦ ${a} / æŒæ¡ ${b}`,
        rptOverall:'æ€»ä½“è¿›åº¦',
        rptOverallSub:(studied,total,masteredPct)=>`å·²å­¦ ${studied} / ${total} è¯ï¼ŒæŒæ¡ç‡ ${masteredPct}%`,
        sharePreviewLabel:'åˆ†äº«é¢„è§ˆ',
        shareBtnLabel:'åˆ†äº«å­¦ä¹ è¿›åº¦',
        shareHint:'è®©æœ‹å‹è§è¯ä½ çš„æˆé•¿ âœ¨',
        shareCopied:'å·²å¤åˆ¶ âœ“',
        shareCopyFallback:'å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ†äº«ï¼š',
        /* AI Insight */
        aiInsightTitle:'AI å­¦ä¹ æ´å¯Ÿ',
        aiInsightBtn:'ç”Ÿæˆå»ºè®®',
        aiInsightBtnRegen:'é‡æ–°ç”Ÿæˆ',
        aiInsightLoading:'AI åˆ†æä¸­â€¦',
        aiInsightSuggestTitle:'å­¦ä¹ å»ºè®®',
        aiInsightErr:'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚',
        aiInsightNoChange:'è¿›åº¦æœªå˜æ›´',
        aiInsightCooldown:(h,m)=>h>0?`${h}h ${m}m åå¯æ›´æ–°`:`${m}m åå¯æ›´æ–°`,
        aiInsightLastGen:(s)=>`ä¸Šæ¬¡ç”Ÿæˆï¼š${s}`,
        aiInsightRetry:'é‡è¯•',
      }
    };

    const state = {
      lang: (navigator.language || '').toLowerCase().startsWith('zh') ? 'zh' : 'en',
      t: null,
      theme: localStorage.getItem('vocabloop_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
      currentTab: 'register',
      touched: { rUser: false, rPass: false, rPass2: false }
    };

    /* â”€â”€ DOM refs â”€â”€ */
    const $ = id => document.getElementById(id);
    const msgEl = $('msg');
    const rUser = $('rUser');
    const rPass = $('rPass');
    const rPass2 = $('rPass2');

    /* â”€â”€ Theme â”€â”€ */
    function applyTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('vocabloop_theme', theme);
    }
    function switchTheme(){ applyTheme(state.theme === 'dark' ? 'light' : 'dark'); }

    /* â”€â”€ i18n â”€â”€ */
    function applyI18n(){
      state.t = I18N[state.lang] || I18N.en;
      const t = state.t;
      document.documentElement.lang = state.lang === 'zh' ? 'zh-CN' : 'en';
      $('backBtn').textContent = t.back;
      $('themeBtn').textContent = t.theme;
      $('title').textContent = t.title;
      $('subtitle').textContent = t.subtitle;
      $('tabRegister').textContent = t.register;
      $('tabLogin').textContent = t.login;
      $('labelUser').textContent = t.username;
      $('ruleUser').textContent = t.userRule;
      $('labelPass').textContent = t.password;
      $('rulePass').textContent = t.passRule;
      $('labelPass2').textContent = t.confirm;
      $('lUserLabel').textContent = t.username;
      $('lPassLabel').textContent = t.password;
      $('registerBtn').querySelector('.btn-text').textContent = t.create;
      $('loginBtn').querySelector('.btn-text').textContent = t.loginBtn;
      rUser.placeholder = t.phUser; rPass.placeholder = t.phPass; rPass2.placeholder = t.phPass2;
      $('lUser').placeholder = t.loginUser;
      $('lPass').placeholder = t.loginPass;
      $('logoutBtn').textContent = t.logout;
      /* Bottom data card */
      $('dataTitle').textContent = t.dataTitle;
      $('exportLabel').textContent = t.exportBtn;
      $('importLabel').textContent = t.importBtn;
      $('dataHint').textContent = t.dataHint;
      /* Offline panel i18n */
      $('offlineTitle').textContent = t.offlineTitle;
      $('offlineDesc').textContent = t.offlineDesc;
    }

    /* â”€â”€ Tab switching with sliding indicator â”€â”€ */
    function switchTab(tab){
      state.currentTab = tab;
      const isRegister = tab === 'register';
      $('tabRegister').classList.toggle('active', isRegister);
      $('tabLogin').classList.toggle('active', !isRegister);
      $('tabSlider').classList.toggle('right', !isRegister);
      $('panelRegister').classList.toggle('active', isRegister);
      $('panelLogin').classList.toggle('active', !isRegister);
      setMsg('', '');
      /* Auto-focus first input */
      setTimeout(() => {
        const target = isRegister ? rUser : $('lUser');
        target.focus();
      }, 280);
    }

    /* â”€â”€ Password toggle â”€â”€ */
    document.querySelectorAll('.toggle-eye').forEach(btn => {
      btn.addEventListener('click', function(){
        const input = $(this.dataset.target);
        input.type = input.type === 'password' ? 'text' : 'password';
        this.textContent = input.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
      });
    });

    /* â”€â”€ Message display â”€â”€ */
    function setMsg(text, type){
      msgEl.className = 'msg';
      const iconEl = msgEl.querySelector('.msg-icon');
      const textEl = msgEl.querySelector('.msg-text');
      textEl.textContent = text || '';
      if(!text){ iconEl.textContent = ''; return; }
      iconEl.textContent = type === 'ok' ? 'âœ“' : 'âœ•';
      msgEl.classList.add(type === 'ok' ? 'ok' : 'err');
    }

    /* â”€â”€ Auth persistence â”€â”€ */
    function saveAuth(user, token){
      if(!user || !user.username || !token) return;
      localStorage.setItem('vocabloop_auth', JSON.stringify({ username:user.username, token, at:Date.now() }));
    }
    function getAuth(){
      try{ return JSON.parse(localStorage.getItem('vocabloop_auth')); }catch(e){ return null; }
    }
    function clearAuth(){ localStorage.removeItem('vocabloop_auth'); }

    /* â”€â”€ Success overlay + redirect with cloud sync â”€â”€ */
    async function showSuccessAndRedirect(){
      const overlay = $('successOverlay');
      overlay.classList.add('show');
      /* Trigger a merge sync so cloud data is pulled before redirect */
      try{ await syncOnAuth(); }catch(e){ /* non-blocking: redirect even if sync fails */ }
      setTimeout(() => {
        /* Use relative path so it works on GitHub Pages subdirectory */
        const base = window.location.pathname.replace(/account\.html.*$/, '');
        window.location.href = base || '/';
      }, 1200);
    }

    /** Sync learning data with cloud on login/register */
    async function syncOnAuth(){
      const auth = getAuth();
      if(!auth || !auth.token) return;
      try{
        /* Collect all local learning data */
        const DECK_IDS = ['pet', 'daily', 'ielts', 'crypto'];
        const decks = {};
        for(const id of DECK_IDS){
          try{
            const raw = localStorage.getItem('srs_' + id + '_v1');
            if(raw) decks[id] = JSON.parse(raw);
          }catch(e){}
        }
        let global = {};
        try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) global = JSON.parse(raw); }catch(e){}
        let readingHistory = [];
        try{ const raw = localStorage.getItem('reading_history'); if(raw) readingHistory = JSON.parse(raw); }catch(e){}

        const localData = {
          decks: decks,
          global: global,
          preferredDeck: localStorage.getItem('preferred_deck') || '',
          readingHistory: readingHistory,
        };

        const r = await fetch('/api/sync', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ action:'merge', token:auth.token, data:localData })
        });
        const result = await r.json();

        /* Apply merged data back to localStorage */
        if(result.ok && result.data){
          const d = result.data;
          if(d.decks){
            for(const id of DECK_IDS){
              if(d.decks[id]) try{ localStorage.setItem('srs_'+id+'_v1', JSON.stringify(d.decks[id])); }catch(e){}
            }
          }
          if(d.global) try{ localStorage.setItem('srs_global_v1', JSON.stringify(d.global)); }catch(e){}
          if(d.preferredDeck) try{ localStorage.setItem('preferred_deck', d.preferredDeck); }catch(e){}
          if(Array.isArray(d.readingHistory)) try{ localStorage.setItem('reading_history', JSON.stringify(d.readingHistory)); }catch(e){}
          try{ localStorage.setItem('vocabloop_sync_ts', String(Date.now())); }catch(e){}
        }
      }catch(e){ /* ignore sync errors â€” don't block redirect */ }
    }

    /* â”€â”€ Toast â”€â”€ */
    function showToast(msg){
      const el = $('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._tid);
      el._tid = setTimeout(() => el.classList.remove('show'), 2200);
    }

    /* â”€â”€ Export / Import â”€â”€ */
    const DECK_IDS = ['pet', 'daily', 'ielts', 'crypto'];

    function today(){
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    function exportProgress(){
      const t = state.t;
      const allState = {};
      for(const id of DECK_IDS){
        try{ const raw = localStorage.getItem('srs_'+id+'_v1'); if(raw) allState[id] = JSON.parse(raw); }catch(e){}
      }
      let global = {};
      try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) global = JSON.parse(raw); }catch(e){}
      let readingHistory = [];
      try{ const raw = localStorage.getItem('reading_history'); if(raw) readingHistory = JSON.parse(raw); }catch(e){}
      const data = {
        version: 1,
        exportDate: new Date().toISOString(),
        global: global,
        decks: allState,
        preferredDeck: localStorage.getItem('preferred_deck') || '',
        readingHistory: readingHistory,
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vocabloop-backup-' + today() + '.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast(t.exportOk);
    }

    function handleImportFile(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const data = JSON.parse(ev.target.result);
          importProgress(data);
        }catch(err){
          showToast(state.t.importFail);
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    }

    function importProgress(data){
      const t = state.t;
      if(!data || typeof data !== 'object' || !data.decks){
        showToast(t.importFail); return;
      }
      if(!confirm(t.importConfirm)) return;

      let mergedCount = 0;
      for(const id of DECK_IDS){
        const importedDeck = data.decks[id];
        if(!importedDeck) continue;
        const importedState = importedDeck.state || {};
        if(Object.keys(importedState).length === 0) continue;

        let localDeck = {};
        try{ const raw = localStorage.getItem('srs_'+id+'_v1'); if(raw) localDeck = JSON.parse(raw); }catch(e){}
        const localState = localDeck.state || {};

        const merged = {};
        const allWords = new Set([...Object.keys(localState), ...Object.keys(importedState)]);
        for(const word of allWords){
          const l = localState[word];
          const c = importedState[word];
          if(!l){ merged[word] = c; continue; }
          if(!c){ merged[word] = l; continue; }
          merged[word] = (l.next||0) >= (c.next||0) ? l : c;
        }
        const mergedDeck = {
          state: merged,
          points: Math.max(localDeck.points||0, importedDeck.points||0),
          streak: Math.max(localDeck.streak||0, importedDeck.streak||0),
          autoPlay: localDeck.autoPlay !== undefined ? localDeck.autoPlay : importedDeck.autoPlay,
        };
        try{ localStorage.setItem('srs_'+id+'_v1', JSON.stringify(mergedDeck)); }catch(e){}
        mergedCount++;
      }

      if(data.global){
        let g = data.global;
        let local = {};
        try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) local = JSON.parse(raw); }catch(e){}
        local.dailyStreak   = Math.max(local.dailyStreak||0, g.dailyStreak||0);
        local.lastStudyDate = (local.lastStudyDate||'') >= (g.lastStudyDate||'') ? local.lastStudyDate : g.lastStudyDate;
        local.totalReviewed = Math.max(local.totalReviewed||0, g.totalReviewed||0);
        if(Array.isArray(g.achievements)){
          local.achievements = [...new Set([...(local.achievements||[]), ...g.achievements])];
        }
        try{ localStorage.setItem('srs_global_v1', JSON.stringify(local)); }catch(e){}
      }

      if(Array.isArray(data.readingHistory) && data.readingHistory.length > 0){
        let existing = [];
        try{ const raw = localStorage.getItem('reading_history'); if(raw) existing = JSON.parse(raw); }catch(e){}
        const seen = new Set();
        const merged = [];
        for(const item of [...existing, ...data.readingHistory]){
          const key = JSON.stringify(item);
          if(!seen.has(key)){ seen.add(key); merged.push(item); }
        }
        try{ localStorage.setItem('reading_history', JSON.stringify(merged.slice(-50))); }catch(e){}
      }

      if(mergedCount > 0){
        showToast(t.importOk(mergedCount));
      } else {
        showToast(t.importEmpty);
      }
    }

    /* â”€â”€ Shake animation helper â”€â”€ */
    function shakeEl(el){
      el.classList.remove('shake');
      void el.offsetWidth;
      el.classList.add('shake');
    }

    /* â”€â”€ Inline hints â”€â”€ */
    function setInline(elId, text, type){
      const el = $(elId);
      el.className = 'inline';
      el.textContent = text || '';
      if(type) el.classList.add(type);
    }

    /* â”€â”€ Password strength meter â”€â”€ */
    function updateStrength(val){
      const fill = $('strengthFill');
      fill.className = 'strength-fill';
      if(!val){ return; }
      const digits = val.replace(/\D/g, '');
      if(digits.length >= 10) fill.classList.add('s3');
      else if(digits.length >= 6) fill.classList.add('s2');
      else if(digits.length >= 1) fill.classList.add('s1');
    }

    /* â”€â”€ Register validation (only validates touched fields) â”€â”€ */
    function validateRegisterForm(submitAttempt){
      const t = state.t;
      const u = rUser.value.trim();
      const p = rPass.value.trim();
      const p2 = rPass2.value.trim();
      let ok = true;

      /* Username */
      if(state.touched.rUser || submitAttempt){
        if(u.length >= 5){
          setInline('rUserHint',t.hUserOk,'ok'); rUser.classList.add('valid'); rUser.classList.remove('invalid');
        } else {
          ok = false; setInline('rUserHint',t.hUserBad,'warn'); rUser.classList.add('invalid'); rUser.classList.remove('valid');
        }
      } else if(u.length < 5) ok = false;

      /* Password */
      if(state.touched.rPass || submitAttempt){
        if(/^\d{6,}$/.test(p)){
          setInline('rPassHint',t.hPassOk,'ok'); rPass.classList.add('valid'); rPass.classList.remove('invalid');
        } else {
          ok = false; setInline('rPassHint',t.hPassBad,'warn'); rPass.classList.add('invalid'); rPass.classList.remove('valid');
        }
      } else if(!/^\d{6,}$/.test(p)) ok = false;

      /* Confirm password */
      if(state.touched.rPass2 || submitAttempt){
        if(p2 && p === p2){
          setInline('rPass2Hint',t.hPass2Ok,'ok'); rPass2.classList.add('valid'); rPass2.classList.remove('invalid');
        } else {
          ok = false; setInline('rPass2Hint',t.hPass2Bad,'err'); rPass2.classList.add('invalid'); rPass2.classList.remove('valid');
        }
      } else if(!p2 || p !== p2) ok = false;

      updateStrength(p);
      return ok;
    }

    /* â”€â”€ Set button loading state â”€â”€ */
    function setBtnLoading(btn, loading, text){
      btn.disabled = loading;
      btn.classList.toggle('loading', loading);
      btn.querySelector('.btn-text').textContent = text;
    }

    /* â”€â”€ API call â”€â”€ */
    async function callAuth(payload){
      const r = await fetch('/api/auth', {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)
      });
      return r.json();
    }

    /* â”€â”€ Register â”€â”€ */
    async function register(){
      const t = state.t;
      /* Mark all fields as touched on submit attempt */
      state.touched.rUser = state.touched.rPass = state.touched.rPass2 = true;
      if(!validateRegisterForm(true)){
        setMsg(t.fixFields, 'err');
        shakeEl($('registerBtn'));
        return;
      }
      const btn = $('registerBtn');
      setBtnLoading(btn, true, t.creating);
      try{
        const data = await callAuth({ action:'register', username:rUser.value.trim(), password:rPass.value.trim() });
        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(t.registerOk, 'ok');
          showSuccessAndRedirect();
        } else {
          const m = (data.message || '').toLowerCase();
          if(m.includes('exists')) setMsg(t.registerTaken, 'err');
          else setMsg(data.message || t.registerFail, 'err');
          shakeEl(btn);
        }
      }catch(_){ setMsg(t.network, 'err'); shakeEl(btn); }
      finally { setBtnLoading(btn, false, t.create); }
    }

    /* â”€â”€ Login â”€â”€ */
    async function login(){
      const t = state.t;
      const btn = $('loginBtn');
      const uVal = $('lUser').value.trim();
      const pVal = $('lPass').value.trim();
      if(!uVal || !pVal){
        setMsg(t.fixFields, 'err'); shakeEl(btn); return;
      }
      setBtnLoading(btn, true, t.logging);
      try{
        const data = await callAuth({ action:'login', username:uVal, password:pVal });
        if(data.ok){
          saveAuth(data.user, data.token);
          setMsg(t.loginOk(data.user?.username || 'user'), 'ok');
          showSuccessAndRedirect();
        } else { setMsg(t.loginFail, 'err'); shakeEl(btn); }
      }catch(_){ setMsg(t.network, 'err'); shakeEl(btn); }
      finally { setBtnLoading(btn, false, t.loginBtn); }
    }

    /* â”€â”€ Logged-in profile view â”€â”€ */
    function showProfile(auth){
      $('authPanel').style.display = 'none';
      $('offlinePanel').style.display = 'none';
      $('profilePanel').style.display = 'flex';
      const name = auth.username || 'User';
      $('profileAvatar').textContent = name.charAt(0).toUpperCase();
      $('profileName').textContent = name;
      $('profileMeta').textContent = state.t.loggedIn;
    }

    function handleLogout(){
      if(!confirm(state.t.logoutConfirm)) return;
      clearAuth();
      $('profilePanel').style.display = 'none';
      $('authPanel').style.display = 'block';
      switchTab('login');
    }

    /* â”€â”€ Event listeners â”€â”€ */
    /* Track which fields user has touched for gentle validation */
    rUser.addEventListener('focus', () => { state.touched.rUser = true; });
    rPass.addEventListener('focus', () => { state.touched.rPass = true; });
    rPass2.addEventListener('focus', () => { state.touched.rPass2 = true; });
    [rUser, rPass, rPass2].forEach(el => el.addEventListener('input', () => validateRegisterForm(false)));

    /* Form submit via Enter key */
    $('registerForm').addEventListener('submit', e => { e.preventDefault(); register(); });
    $('loginForm').addEventListener('submit', e => { e.preventDefault(); login(); });

    /* Tab buttons */
    $('tabRegister').addEventListener('click', () => switchTab('register'));
    $('tabLogin').addEventListener('click', () => switchTab('login'));

    /* Theme & logout */
    $('themeBtn').addEventListener('click', switchTheme);
    $('logoutBtn').addEventListener('click', handleLogout);

    /* â”€â”€ Backend detection â”€â”€ */
    async function checkBackend(){
      try{
        const base = window.location.pathname.replace(/account\.html.*$/, '');
        const res = await fetch(base + 'api/auth', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ action: 'ping' }),
        });
        const ct = (res.headers.get('content-type') || '');
        if(ct.includes('application/json') || ct.includes('text/json')){
          const data = await res.json();
          return !!(data && data.ok === true && data.message === 'pong');
        }
      }catch(_){}
      return false;
    }

    function showOfflineMode(){
      // No backend â€” hide the entire account card (login/register not useful offline)
      $('accountCard').style.display = 'none';
    }

    /* â”€â”€ Learning Report â”€â”€ */
    const DECK_META = [
      { id:'pet',    name:'PET',    file:'data/pet-words-1000.json',    emoji:'ğŸ“' },
      { id:'daily',  name:'Daily',  file:'data/daily-words-1000.json',  emoji:'ğŸ’¬' },
      { id:'ielts',  name:'IELTS',  file:'data/ielts-words.json',       emoji:'ğŸ“' },
      { id:'crypto', name:'Crypto', file:'data/crypto-words-1000.json', emoji:'â‚¿' },
    ];
    const ACHIEVE_META = {
      first_review:{emoji:'ğŸ¯',en:'First Review',zh:'åˆæ¬¡å¤ä¹ '},
      review_100:  {emoji:'ğŸ’ª',en:'100 Reviews',zh:'100 æ¬¡å¤ä¹ '},
      review_500:  {emoji:'ğŸ”¥',en:'500 Reviews',zh:'500 æ¬¡å¤ä¹ '},
      review_1000: {emoji:'âš¡',en:'1000 Reviews',zh:'1000 æ¬¡å¤ä¹ '},
      master_1:    {emoji:'â­',en:'First Mastery',zh:'é¦–æ¬¡æŒæ¡'},
      master_10:   {emoji:'ğŸŒŸ',en:'10 Mastered',zh:'æŒæ¡ 10 è¯'},
      master_100:  {emoji:'ğŸ…',en:'100 Mastered',zh:'æŒæ¡ 100 è¯'},
      streak_3:    {emoji:'ğŸ“…',en:'3-Day Streak',zh:'è¿ç»­ 3 å¤©'},
      streak_7:    {emoji:'ğŸ—“ï¸',en:'7-Day Streak',zh:'è¿ç»­ 7 å¤©'},
      streak_30:   {emoji:'ğŸ‘‘',en:'30-Day Streak',zh:'è¿ç»­ 30 å¤©'},
    };

    /* â”€â”€ Animated counter â”€â”€ */
    function animateCounter(el, target, suffix){
      suffix = suffix || '';
      const duration = 800;
      const start = performance.now();
      const from = 0;
      function step(now){
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
        const current = Math.round(from + (target - from) * eased);
        el.textContent = current + suffix;
        if(progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    /* â”€â”€ Toggle collapsible sections â”€â”€ */
    function toggleSection(bodyId, toggleId){
      const body = $(bodyId);
      const toggle = $(toggleId);
      const isCollapsed = body.classList.contains('collapsed');
      body.classList.toggle('collapsed');
      toggle.classList.toggle('collapsed');
    }

    async function fetchDeckTotals(){
      const totals = {};
      await Promise.all(DECK_META.map(async d => {
        try{
          const base = window.location.pathname.replace(/account\.html.*$/, '');
          const r = await fetch(base + d.file);
          const data = await r.json();
          totals[d.id] = Array.isArray(data) ? data.length : 0;
        }catch(e){ totals[d.id] = 0; }
      }));
      return totals;
    }

    function getDeckWords(deckId){
      try{
        const raw = localStorage.getItem('srs_'+deckId+'_v1');
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed.state || {};
      }catch(e){ return {}; }
    }

    /* â”€â”€ Share progress â”€â”€ */
    let _shareData = null;

    function buildShareText(d) {
      const lang = state.lang;
      const milestone = (() => {
        if (d.streak >= 30) return lang === 'zh' ? 'ğŸ† åšæŒå­¦ä¹  30 å¤©ï¼' : 'ğŸ† 30-day champion!';
        if (d.streak >= 7)  return lang === 'zh' ? 'ğŸ”¥ è¿ç»­å­¦ä¹  7 å¤©ï¼'  : 'ğŸ”¥ 7-day streak!';
        if (d.mastered >= 200) return lang === 'zh' ? 'ğŸ‘‘ å·²æŒæ¡ 200 è¯ï¼'  : 'ğŸ‘‘ 200 words mastered!';
        if (d.mastered >= 100) return lang === 'zh' ? 'ğŸ¯ 100 è¯é‡Œç¨‹ç¢‘ï¼'   : 'ğŸ¯ 100 words milestone!';
        if (d.pct >= 50)    return lang === 'zh' ? 'ğŸŒŸ å·²å®Œæˆä¸€åŠï¼'      : 'ğŸŒŸ Halfway there!';
        return '';
      })();
      const lines = lang === 'zh'
        ? [
            `ğŸ“š æˆ‘åœ¨ VocabLoop å­¦äº† ${d.studied} ä¸ªè‹±è¯­å•è¯ï¼`,
            milestone,
            `âœ… å·²æŒæ¡ ${d.mastered} ä¸ª | å­¦ä¹ è¿›åº¦ ${d.pct}%`,
            d.streak > 0 ? `ğŸ”¥ è¿ç»­å­¦ä¹  ${d.streak} å¤©` : '',
            `â†’ ${d.url}`,
          ]
        : [
            `ğŸ“š I've studied ${d.studied} English words on VocabLoop!`,
            milestone,
            `âœ… Mastered ${d.mastered} Â· ${d.pct}% progress`,
            d.streak > 0 ? `ğŸ”¥ ${d.streak}-day learning streak` : '',
            `â†’ ${d.url}`,
          ];
      return lines.filter(Boolean).join('\n');
    }

    function updateShareBanner() {
      if (!_shareData) return;
      const t = state.t;
      $('sharePreviewLabel').textContent = t.sharePreviewLabel;
      $('sharePreviewText').textContent = buildShareText(_shareData);
      $('shareBtnLabel').textContent = t.shareBtnLabel;
      $('shareHintText').textContent = t.shareHint;
    }

    async function doShareProgress() {
      if (!_shareData) return;
      const t = state.t;
      const text  = buildShareText(_shareData);
      const title = state.lang === 'zh' ? 'æˆ‘çš„ VocabLoop å­¦ä¹ è¿›åº¦' : 'My VocabLoop Progress';
      const btn   = $('shareMainBtn');
      const label = $('shareBtnLabel');
      if (navigator.share) {
        try { await navigator.share({ title, text, url: _shareData.url }); return; }
        catch(e) { if (e.name === 'AbortError') return; }
      }
      try {
        await navigator.clipboard.writeText(text);
        btn.classList.add('copied');
        label.textContent = t.shareCopied;
        setTimeout(() => { btn.classList.remove('copied'); updateShareBanner(); }, 2200);
      } catch(e) {
        prompt(t.shareCopyFallback, text);
      }
    }

    /* â”€â”€ AI Learning Insights â€” cache + rate limit â”€â”€ */
    const INSIGHT_CACHE_KEY  = 'vocabloop_insight_v1';
    const INSIGHT_COOLDOWN_MS = 12 * 60 * 60 * 1000; // 12 h
    let _currentInsightHash = null;

    function getInsightCache() {
      try { return JSON.parse(localStorage.getItem(INSIGHT_CACHE_KEY) || 'null'); } catch(e) { return null; }
    }
    function saveInsightCache(hash, summary, suggestions) {
      localStorage.setItem(INSIGHT_CACHE_KEY, JSON.stringify({ ts: Date.now(), hash, summary, suggestions }));
    }
    function fmtTimeAgo(ts) {
      const diff = Date.now() - ts;
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      return state.lang === 'zh'
        ? (h > 0 ? `${h} å°æ—¶å‰` : (m > 0 ? `${m} åˆ†é’Ÿå‰` : 'åˆšåˆš'))
        : (h > 0 ? `${h}h ago`  : (m > 0 ? `${m}m ago`  : 'just now'));
    }
    function showInsightResult(summary, suggestions) {
      $('aiInsightSummary').textContent = summary || '';
      const ul = $('aiInsightSuggestions');
      ul.innerHTML = '';
      (suggestions || []).forEach(s => {
        const li = document.createElement('li');
        li.textContent = s;
        ul.appendChild(li);
      });
      $('aiInsightBody').style.display   = 'block';
      $('aiInsightResult').style.display = 'block';
      $('aiInsightLoading').style.display = 'none';
      $('aiInsightErr').style.display    = 'none';
    }
    function initInsightSection() {
      const t  = state.t;
      const btn = $('aiInsightBtn');
      const statusEl = $('aiInsightStatus');
      $('aiInsightSection').style.display     = '';
      $('aiInsightTitle').textContent         = t.aiInsightTitle;
      $('aiInsightLoadingText').textContent   = t.aiInsightLoading;
      $('aiInsightSuggestTitle').textContent  = t.aiInsightSuggestTitle;

      const cache = getInsightCache();
      btn.style.display = 'none'; // hidden by default; shown only when needed

      if (!cache) {
        /* First time â€” auto-generate */
        statusEl.style.display = 'none';
        generateInsight();
        return;
      }

      /* Always show cached result immediately */
      showInsightResult(cache.summary, cache.suggestions);
      statusEl.textContent   = t.aiInsightLastGen(fmtTimeAgo(cache.ts));
      statusEl.style.display = 'block';

      const cooldownLeft = INSIGHT_COOLDOWN_MS - (Date.now() - (cache.ts || 0));
      const dataChanged  = _currentInsightHash && _currentInsightHash !== cache.hash;

      if (!dataChanged) {
        /* Nothing changed â€” keep cached result, button stays hidden */
      } else if (cooldownLeft > 0) {
        /* Data changed but cooldown active â€” show timer button */
        const h = Math.floor(cooldownLeft / 3600000);
        const m = Math.ceil((cooldownLeft % 3600000) / 60000);
        $('aiInsightBtnLabel').textContent = t.aiInsightCooldown(h, m);
        btn.disabled = true;
        btn.style.display = '';
      } else {
        /* Data changed + cooldown expired â€” auto-regenerate */
        generateInsight();
      }
    }

    async function generateInsight() {
      const t = state.t;
      const btn      = $('aiInsightBtn');
      const loadEl   = $('aiInsightLoading');
      const errEl    = $('aiInsightErr');
      const statusEl = $('aiInsightStatus');

      /* Guard: honour rate-limit and no-change rule */
      const cache = getInsightCache();
      if (cache) {
        const cooldownLeft = INSIGHT_COOLDOWN_MS - (Date.now() - (cache.ts || 0));
        const dataChanged  = _currentInsightHash && _currentInsightHash !== cache.hash;
        if (!dataChanged) return;
        if (cooldownLeft > 0) return;
      }

      btn.style.display                   = 'none';
      btn.disabled                        = true;
      $('aiInsightBody').style.display    = 'block';
      loadEl.style.display                = 'flex';
      $('aiInsightResult').style.display  = 'none';
      errEl.style.display                 = 'none';
      statusEl.style.display              = 'none';

      try {
        /* Collect stats (mirrors renderReport stats loop) */
        const globalState = (() => {
          try { return JSON.parse(localStorage.getItem('srs_global_v1') || '{}'); } catch(e) { return {}; }
        })();
        const totals = await fetchDeckTotals();
        const decks = [], difficultWords = [];
        const stages = { new: 0, learning: 0, review: 0, mastered: 0 };
        let allStudied = 0, allMastered = 0, totalWords = 0;

        for (const d of DECK_META) {
          const words = getDeckWords(d.id);
          const total = totals[d.id] || 0;
          totalWords += total;
          let studied = 0, mastered = 0;
          for (const [w, s] of Object.entries(words)) {
            if (w.startsWith('_') || !s || !s.stage) continue;
            if (s.stage !== 'new') studied++;
            if (s.stage === 'mastered') mastered++;
            if      (s.stage === 'new')     stages.new++;
            else if (s.stage === 'learning' || s.stage === 'relearn' || s.stage === 'young') stages.learning++;
            else if (s.stage === 'mature')  stages.review++;
            else if (s.stage === 'mastered') stages.mastered++;
            if ((s.againCount || 0) >= 2 && s.stage !== 'mastered')
              difficultWords.push({ word: w, againCount: s.againCount });
          }
          allStudied  += studied;
          allMastered += mastered;
          stages.new  += Math.max(0, total - Object.keys(words).filter(k => !k.startsWith('_')).length);
          decks.push({ name: d.name, total, studied, mastered });
        }
        difficultWords.sort((a, b) => b.againCount - a.againCount);

        const base = window.location.pathname.replace(/account\.html.*$/, '');
        const res = await fetch(base + 'api/insight', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lang: state.lang, studied: allStudied, mastered: allMastered,
            total: totalWords, streak: globalState.dailyStreak || 0,
            reviewedTotal: globalState.totalReviewed || 0,
            decks, stages, difficultWords: difficultWords.slice(0, 5),
          })
        });

        loadEl.style.display = 'none';
        if (!res.ok) throw new Error('API error');
        const data = await res.json();

        saveInsightCache(_currentInsightHash, data.summary, data.suggestions);
        showInsightResult(data.summary, data.suggestions);

        /* Success â€” hide button, update status */
        btn.style.display      = 'none';
        statusEl.textContent   = t.aiInsightLastGen(fmtTimeAgo(Date.now()));
        statusEl.style.display = 'block';

      } catch(e) {
        loadEl.style.display = 'none';
        errEl.textContent    = t.aiInsightErr;
        errEl.style.display  = 'block';
        /* Show retry button */
        $('aiInsightBtnLabel').textContent = t.aiInsightRetry;
        btn.disabled = false;
        btn.style.display = '';
      }
    }

    async function renderReport(){
      const t = state.t;
      /* i18n labels */
      $('reportTitle').textContent = t.rptTitle;
      $('rStudiedL').textContent = t.rptStudied;
      $('rMasteredL').textContent = t.rptMastered;
      $('rReviewedL').textContent = t.rptReviewed;
      $('rStreakL').textContent = t.rptStreak;
      $('rDeckTitle').textContent = t.rptDeckTitle;
      $('rStageTitle').textContent = t.rptStageTitle;
      $('rDiffTitle').textContent = t.rptDiffTitle;
      $('rAchieveTitle').textContent = t.rptAchieveTitle;

      /* Global state */
      let globalState = {};
      try{ const raw = localStorage.getItem('srs_global_v1'); if(raw) globalState = JSON.parse(raw); }catch(e){}

      /* Collect all words across decks */
      const totals = await fetchDeckTotals();
      let allStudied = 0, allMastered = 0, totalWords = 0;
      let stageNew = 0, stageLearning = 0, stageReview = 0, stageMastered = 0;
      const difficultWords = [];
      const deckStats = [];

      for(const d of DECK_META){
        const words = getDeckWords(d.id);
        const total = totals[d.id] || 0;
        totalWords += total;
        let studied = 0, mastered = 0;
        for(const [w, s] of Object.entries(words)){
          if(w.startsWith('_')) continue;
          if(!s || !s.stage) continue;
          if(s.stage !== 'new') studied++;
          if(s.stage === 'mastered') mastered++;
          if(s.stage === 'new') stageNew++;
          else if(s.stage === 'learning' || s.stage === 'relearn' || s.stage === 'young') stageLearning++;
          else if(s.stage === 'mature') stageReview++;
          else if(s.stage === 'mastered') stageMastered++;
          if((s.againCount || 0) >= 2 && s.stage !== 'mastered'){
            difficultWords.push({ word: w, zh: '', againCount: s.againCount, deckName: d.name });
          }
        }
        allStudied += studied;
        allMastered += mastered;
        const unseenNew = Math.max(0, total - Object.keys(words).filter(k=>!k.startsWith('_')).length);
        stageNew += unseenNew;
        deckStats.push({ id: d.id, name: d.name, total, studied, mastered, emoji: d.emoji });
      }

      /* Data fingerprint for AI insight change detection */
      _currentInsightHash = `${allStudied}:${allMastered}:${totalWords}:${globalState.totalReviewed || 0}`;

      /* Check if there's any data at all */
      const hasData = allStudied > 0 || (globalState.totalReviewed || 0) > 0;
      if(!hasData){
        $('reportCard').style.display = 'block';
        $('reportCard').querySelector('.report-title').innerHTML =
          '<span class="report-title-icon">ğŸ“Š</span> <span id="reportTitle">' + t.rptTitle + '</span>';
        /* Hide everything except title + empty message */
        $('overallProgress').style.display = 'none';
        $('reportMetrics').style.display = 'none';
        $('deckSection').style.display = 'none';
        $('stageSection').style.display = 'none';
        $('difficultSection').style.display = 'none';
        $('achieveSection').style.display = 'none';
        $('aiInsightSection').style.display = 'none';
        /* Insert empty state if not already there */
        let emptyEl = $('reportEmpty');
        if(!emptyEl){
          emptyEl = document.createElement('div');
          emptyEl.id = 'reportEmpty';
          emptyEl.className = 'report-empty';
          emptyEl.innerHTML = '<div class="report-empty-icon">ğŸ“–</div><div class="report-empty-text">' + t.rptEmpty + '</div>';
          $('reportCard').appendChild(emptyEl);
        }
        return;
      }

      /* Remove empty state if present */
      const emptyEl = $('reportEmpty');
      if(emptyEl) emptyEl.remove();

      $('reportCard').style.display = 'block';
      $('reportMetrics').style.display = '';
      $('deckSection').style.display = '';
      $('stageSection').style.display = '';

      /* â”€â”€ Overall progress ring â”€â”€ */
      const overallPct = totalWords > 0 ? Math.round(allStudied / totalWords * 100) : 0;
      $('overallProgress').style.display = 'flex';
      $('overallTitle').textContent = t.rptOverall;
      const masteredPctVal = totalWords > 0 ? Math.round(allMastered / totalWords * 100) : 0;
      $('overallSub').textContent = t.rptOverallSub(allStudied, totalWords, masteredPctVal);
      const circumference = 2 * Math.PI * 28; // r=28
      const ringOffset = circumference * (1 - overallPct / 100);
      requestAnimationFrame(() => {
        const ringFill = $('overallRingFill');
        ringFill.style.strokeDashoffset = ringOffset;
        animateCounter($('overallPct'), overallPct, '%');
      });

      /* â”€â”€ Key metrics with animated counters â”€â”€ */
      requestAnimationFrame(() => {
        animateCounter($('rStudied'), allStudied, '');
        animateCounter($('rMastered'), allMastered, '');
        animateCounter($('rReviewed'), globalState.totalReviewed || 0, '');
        animateCounter($('rStreak'), globalState.dailyStreak || 0, 'd');
      });

      /* â”€â”€ Deck progress bars (animated) â”€â”€ */
      const deckBarsEl = $('deckBars');
      deckBarsEl.innerHTML = '';
      for(const ds of deckStats){
        if(ds.total === 0) continue;
        const studiedL = state.lang === 'zh' ? 'å·²å­¦' : 'studied';
        const masteredL = state.lang === 'zh' ? 'æŒæ¡' : 'mastered';
        deckBarsEl.innerHTML += `
          <div class="deck-row">
            <div class="deck-row-header">
              <span class="deck-name">${ds.emoji} ${ds.name} <span class="deck-name-badge">${Math.round(ds.studied/ds.total*100)}%</span></span>
              <span class="deck-nums">${ds.studied} ${studiedL} / ${ds.total}</span>
            </div>
            <div class="bar-bg">
              <div class="bar-fill fill-studied" data-pct="${Math.round(ds.studied/ds.total*100)}" style="width:0%"></div>
              <div class="bar-fill fill-mastered" data-pct="${Math.round(ds.mastered/ds.total*100)}" style="width:0%"></div>
            </div>
            <div class="deck-legend">
              <span class="deck-legend-item"><span class="deck-legend-dot" style="background:linear-gradient(90deg,#2563eb,#60a5fa)"></span> ${ds.studied} ${studiedL}</span>
              <span class="deck-legend-item"><span class="deck-legend-dot" style="background:linear-gradient(90deg,#8b5cf6,#c4b5fd)"></span> ${ds.mastered} ${masteredL}</span>
            </div>
          </div>`;
      }
      /* Animate bars after DOM update */
      requestAnimationFrame(() => {
        deckBarsEl.querySelectorAll('.bar-fill').forEach(el => {
          el.style.width = el.dataset.pct + '%';
        });
      });

      /* â”€â”€ Stage distribution: Ring chart + legend â”€â”€ */
      const stageChartEl = $('stageChartWrap');
      const stageTotal = stageNew + stageLearning + stageReview + stageMastered;
      const stages = [
        { name: t.rptNew,           count: stageNew,       color: '#3b82f6' },
        { name: t.rptLearning,      count: stageLearning,  color: '#f59e0b' },
        { name: t.rptReview,        count: stageReview,    color: '#10b981' },
        { name: t.rptMasteredStage, count: stageMastered,  color: '#8b5cf6' },
      ];

      /* Build SVG ring chart */
      const R = 48, cx = 60, cy = 60;
      const C = 2 * Math.PI * R;
      let offset = 0;
      let ringSegments = '';
      for(const s of stages){
        const pct = stageTotal > 0 ? s.count / stageTotal : 0;
        const len = pct * C;
        if(len > 0){
          ringSegments += `<circle cx="${cx}" cy="${cy}" r="${R}" stroke="${s.color}" stroke-width="12"
            stroke-dasharray="${len} ${C - len}" stroke-dashoffset="${-offset}"
            stroke-linecap="butt" style="transition:stroke-dashoffset .8s ease, stroke-dasharray .8s ease"/>`;
        }
        offset += len;
      }

      let legendHtml = '';
      for(const s of stages){
        const pct = stageTotal > 0 ? Math.round(s.count / stageTotal * 100) : 0;
        legendHtml += `
          <div class="stage-row">
            <span class="stage-dot" style="background:${s.color}"></span>
            <span class="stage-name">${s.name}</span>
            <span class="stage-count">${s.count}</span>
            <span class="stage-pct">${pct}%</span>
          </div>`;
      }

      const ringCenterLabel = state.lang === 'zh' ? 'æ€»è¯æ•°' : 'Words';
      stageChartEl.innerHTML = `
        <div class="ring-chart">
          <svg viewBox="0 0 120 120">
            <circle cx="${cx}" cy="${cy}" r="${R}" stroke="var(--line)" stroke-width="12"/>
            ${ringSegments}
          </svg>
          <div class="ring-center">
            <div class="ring-center-val">${stageTotal}</div>
            <div class="ring-center-label">${ringCenterLabel}</div>
          </div>
        </div>
        <div class="stage-legend">${legendHtml}</div>`;

      /* â”€â”€ Difficult words with severity colors â”€â”€ */
      if(difficultWords.length > 0){
        difficultWords.sort((a, b) => b.againCount - a.againCount);
        const top10 = difficultWords.slice(0, 10);
        const wordMap = {};
        await Promise.all(DECK_META.map(async d => {
          try{
            const base = window.location.pathname.replace(/account\.html.*$/, '');
            const r = await fetch(base + d.file);
            const data = await r.json();
            for(const w of data) wordMap[w.word] = w.zh || '';
          }catch(e){}
        }));
        const listEl = $('difficultList');
        listEl.innerHTML = '';
        top10.forEach((dw, i) => {
          const zh = wordMap[dw.word] || '';
          const severity = dw.againCount >= 5 ? 'high' : dw.againCount >= 3 ? 'med' : 'low';
          listEl.innerHTML += `
            <div class="diff-item severity-${severity}" style="animation:rptFadeUp .4s ease both;animation-delay:${i * .05}s">
              <span class="diff-rank">${i + 1}</span>
              <span class="diff-word">${dw.word}</span>
              <span class="diff-zh">${zh}</span>
              <span class="diff-badge">${t.rptAgain(dw.againCount)}</span>
            </div>`;
        });
        $('difficultSection').style.display = 'block';
      }

      /* â”€â”€ Achievements with staggered animation â”€â”€ */
      const achievements = globalState.achievements || [];
      if(achievements.length > 0){
        const listEl = $('achieveList');
        listEl.innerHTML = '';
        achievements.forEach((id, i) => {
          const meta = ACHIEVE_META[id];
          if(!meta) return;
          const label = state.lang === 'zh' ? meta.zh : meta.en;
          listEl.innerHTML += `<span class="achieve-pill" style="animation-delay:${i * .08}s">
            <span class="achieve-emoji">${meta.emoji}</span> ${label}</span>`;
        });
        $('achieveSection').style.display = 'block';
      }

      /* â”€â”€ Share banner â”€â”€ */
      const shareUrl = window.location.origin +
        window.location.pathname.replace(/account\.html.*$/, '');
      _shareData = {
        studied: allStudied,
        mastered: allMastered,
        total:    totalWords,
        pct:      overallPct,
        streak:   globalState.dailyStreak || 0,
        url:      shareUrl,
      };
      updateShareBanner();
      $('shareProgress').style.display = '';

      /* â”€â”€ AI Insight section â”€â”€ */
      initInsightSection();
    }

    /* â”€â”€ Init â”€â”€ */
    applyTheme(state.theme);
    applyI18n();

    /* Detect backend, then show appropriate view */
    checkBackend().then(function(available){
      if(!available){
        showOfflineMode();
      } else {
        /* Backend available â€” normal flow */
        const existingAuth = getAuth();
        if(existingAuth && existingAuth.username){
          showProfile(existingAuth);
        } else {
          $('authPanel').style.display = 'block';
          switchTab('register');
        }
      }
      /* Always render learning report (data is local) */
      renderReport();
    });
  </script>
</body>
</html>
